<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ellis Web Bell 5.39.0</title>

    <!-- V5.51.0: PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1d4ed8">
    <meta name="description" content="A real-time, synchronized school bell schedule and timer system">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Web Bell">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%232563EB%22><path d=%22M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z%22/></svg>">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Tone.js for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Use Century Gothic, with Urbanist and Questrial as web-safe fallbacks
                        sans: ['Century Gothic', 'Urbanist', 'Questrial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- V5.49.3: Added Urbanist as Century Gothic fallback (before Questrial) -->
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700&family=Questrial&display=swap" rel="stylesheet">

	<!-- Moving to stylesheet 5.06-->
    <link rel="stylesheet" href="styles.css">

</head>
<body class="bg-gray-100 text-gray-900 font-sans"> <!-- Added font-sans to apply tailwind default -->


    <div id="welcome-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-lg shadow-xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-700 mb-4">Welcome to the Ellis Web Bell!</h2>
            <p class="text-gray-600 mb-8">Please sign in to load and sync schedules.</p>
            <div class="space-y-4">
                <button id="google-start-btn" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-white text-gray-700 font-medium rounded-lg shadow-md border border-gray-200 hover:bg-gray-50 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 48 48">
                        <path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.28 6.42C12.92 13.9 18.06 9.5 24 9.5z"></path>
                        <path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 2.73-2.2 5.08-4.79 6.69l7.38 5.71C44.97 36.3 46.98 30.8 46.98 24.55z"></path>
                        <path fill="#FBBC05" d="M10.84 28.71C10.22 26.9 9.83 24.99 9.83 23c0-1.99.39-3.9 1.01-5.71L2.56 10.8C.9 14.28 0 18.48 0 23c0 4.52.9 8.72 2.56 12.2l8.28-6.49z"></path>
                        <path fill="#EA4335" d="M24 48c5.4 0 10.32-1.62 14.34-4.38l-7.38-5.71C28.71 40.5 26.47 42.1 24 42.1c-5.94 0-11.08-4.4-12.96-10.28L2.56 38.2C6.51 46.04 14.62 48 24 48z"></path>
                        <path fill="none" d="M0 0h48v48H0z"></path>
                    </svg>
                    Sign in with Google
                </button>
                <button id="anonymous-start-btn" class="w-full px-6 py-3 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                    Continue Anonymously
                </button>
            </div>
        </div>
    </div>


    <div id="audio-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden">
        <button id="start-audio-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-2xl rounded-lg shadow-lg hover:bg-blue-700 transition-colors text-center">
            <!-- MODIFIED: Default text changed, will be updated by JS -->
            Loading...
        </button>
    </div>

    <!-- NEW: Add Bell to Multiple Schedules Modal -->
    <div id="add-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="multi-add-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-medium mb-6">Add Bell to Schedules</h3>

            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="multi-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="multi-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="multi-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="multi-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="multi-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <!-- V5.49: Added preview button -->
                <div class="flex items-center gap-2 mt-1">
                    <select id="multi-bell-sound" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <optgroup label="Default Sounds">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <!-- MODIFIED: Made Ellis Bell selected by default -->
                            <option value="ellisBell.mp3" selected>Ellis Bell</option>
                        </optgroup>
                        <optgroup label="My Sounds" id="multi-my-sounds-optgroup"></optgroup>
                        <optgroup label="Shared Sounds" id="multi-shared-sounds-optgroup"></optgroup>
                    </select>
                    <button type="button" id="preview-multi-bell-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                        ‚ñ∂
                    </button>
                </div>
            </div>

			<!-- NEW 5.19 Visual Cue Picker -->
			<div class="mb-4">
			    <label for="multi-bell-visual" class="block text-sm font-medium text-gray-700 mb-1">Visual Cue</label>
			    <select id="multi-bell-visual" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
			        <option value="">[None / Period Default]</option>
			        <option value="[UPLOAD]">Upload Image...</option>
			        <option value="[CUSTOM_TEXT]">Custom Text/Color...</option>
			    </select>
			</div>

			<!-- NEW 5.18: Visual Display Mode -->
			<!-- MODIFIED V5.42: Two-column layout with centralized CSS -->
			<div class="visual-mode-preview-grid">
			    <!-- Left Column: Visual Display Mode -->
			    <div>
			        <label class="block text-sm font-medium text-gray-700 mb-2">Visual Display</label>
			        <div class="visual-mode-stack">
			            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
			                <input type="radio" name="multi-add-visual-mode" value="none" checked class="mr-2">
			                <span class="text-sm">None</span>
			            </label>
			            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
			                <input type="radio" name="multi-add-visual-mode" value="before" class="mr-2">
			                <span class="text-sm">Before</span>
			            </label>
			            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
			                <input type="radio" name="multi-add-visual-mode" value="after" class="mr-2">
			                <span class="text-sm">After</span>
			            </label>
			        </div>
			        <p class="text-xs text-gray-500 mt-2">
			            <strong>Before:</strong> Show while counting down<br>
			            <strong>After:</strong> Show after bell rings
			        </p>
			    </div>
			    
			    <!-- Right Column: Preview -->
			    <div>
			        <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
			        <div id="multi-bell-visual-preview" class="visual-preview-full">
			            <span class="visual-preview-placeholder">Select visual</span>
			        </div>
			    </div>
			</div>

            <!-- Schedule Checkboxes -->
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Schedules to Add to:</label>

                <div class="flex gap-2 mb-2">
                    <button type="button" id="multi-select-all" class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300">Select All</button>
                    <button type="button" id="multi-select-none" class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300">Select None</button>
                </div>
                <div id="multi-schedule-list-container" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <!-- Checkboxes will be dynamically injected here -->
                    <p class="text-gray-500">Loading schedules...</p>
                </div>
            </div>

            <p id="multi-add-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="multi-add-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="multi-add-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Bell</button>
            </div>
        </form>
    </div>

    <!-- NEW: Edit Bell Modal (Admin) -->
    <div id="edit-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-medium mb-6">Edit Bell</h3>

            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div class="mb-4">
				    <label for="edit-bell-time" class="block text-sm font-medium text-gray-700 mb-1">
				        Time (HH:MM:SS)
				    </label>
				    <!-- Lock message will be inserted here by JS as a separate line -->
				    <div id="edit-time-lock-message" class="hidden text-xs text-gray-500 mb-1">
				        üîí Only admin can change anchor bell times
				    </div>
				    <input type="time" id="edit-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
				</div>
                <div>
                    <label for="edit-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="edit-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex items-end gap-2">
                <div class="flex-grow">
                    <label for="edit-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>

                    <select id="edit-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <optgroup label="Default Sounds">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <!-- MODIFIED: Made Ellis Bell selected by default -->
                            <option value="ellisBell.mp3" selected>Ellis Bell</option>
                        </optgroup>
                        <optgroup label="My Sounds" id="edit-my-sounds-optgroup"></optgroup>
                        <optgroup label="Shared Sounds" id="edit-shared-sounds-optgroup"></optgroup>
                    </select>
                </div>

                <button type="button" id="preview-edit-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                    &#9654;
                </button>
            </div>
            <!-- END V4.95 MODIFICATION -->

			<!-- NEW 5.19 Visual Cue Picker -->
			<div class="mb-4">
			    <label for="edit-bell-visual" class="block text-sm font-medium text-gray-700 mb-1">Visual Cue</label>
			    <select id="edit-bell-visual" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
			        <option value="">[None / Period Default]</option>
			        <option value="[UPLOAD]">Upload Image...</option>
			        <option value="[CUSTOM_TEXT]">Custom Text/Color...</option>
			        <!-- Options will be populated by JS -->
			    </select>
			</div>

			<!-- Visual Display & Preview (Side by Side) -->
			<!-- MODIFIED V5.42: Use centralized CSS classes -->
			<div class="visual-mode-preview-grid">
			    <!-- Left: Display Controls -->
			    <div>
			        <label class="block text-sm font-medium text-gray-700 mb-2">Visual Display</label>
			        <div class="visual-mode-stack">
			            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
			                <input type="radio" name="edit-visual-mode" value="none" checked class="mr-2">
			                <span class="text-sm">None</span>
			            </label>
			            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
			                <input type="radio" name="edit-visual-mode" value="before" class="mr-2">
			                <span class="text-sm">Before</span>
			            </label>
			            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
			                <input type="radio" name="edit-visual-mode" value="after" class="mr-2">
			                <span class="text-sm">After</span>
			            </label>
			        </div>
			        <p class="text-xs text-gray-500 mt-2">
			            <strong>Before:</strong> Show while counting down<br>
			            <strong>After:</strong> Show after bell rings
			        </p>
			    </div>

			    <!-- Right: Preview -->
			    <div>
			        <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
			        <div id="edit-bell-visual-preview" class="visual-preview-full">
			            <span class="visual-preview-placeholder">Select visual</span>
			        </div>
			    </div>
			</div>

            <!-- NEW in 4.21: Override sound checkbox for shared bells -->
            <!-- Override shared sound checkbox -->
			<div id="edit-bell-override-container" class="mb-4 hidden">
			    <label class="flex items-center space-x-2 cursor-pointer">
			        <input type="checkbox" id="edit-bell-override-checkbox" class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
			        <span class="text-sm text-gray-700">Override shared sound for all users</span>
			    </label>
			</div>

			<!-- NEW 5.20: Override visual checkbox (admin only) -->
			<div id="edit-bell-visual-override-container" class="mb-4 hidden">
			    <label class="flex items-center space-x-2 cursor-pointer">
			        <input type="checkbox" id="edit-bell-visual-override-checkbox" class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
			        <span class="text-sm text-gray-700">Override shared visual for all users</span>
			    </label>
			</div>

            <p id="edit-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="edit-bell-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- V5.46.0: Bulk Edit Modal -->
    <div id="bulk-edit-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-medium mb-2">Bulk Edit Bells</h3>
            <p id="bulk-edit-count" class="text-gray-600 mb-6">0 bells selected</p>

            <!-- Sound Selection -->
            <div class="mb-6">
                <label for="bulk-edit-sound" class="block text-sm font-medium text-gray-700 mb-1">Change Sound</label>
                <div class="flex items-end gap-2">
                    <select id="bulk-edit-sound" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="[NO_CHANGE]">‚Äî Don't change ‚Äî</option>
                        <optgroup label="Default Sounds">
                            <option value="ellisBell.mp3">Ellis Bell</option>
                        </optgroup>
                        <optgroup label="My Sounds" id="bulk-my-sounds-optgroup"></optgroup>
                        <optgroup label="Shared Sounds" id="bulk-shared-sounds-optgroup"></optgroup>
                    </select>
                    <button type="button" id="bulk-preview-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                        &#9654;
                    </button>
                </div>
            </div>

            <!-- Visual Cue Selection -->
            <div class="mb-6">
                <label for="bulk-edit-visual" class="block text-sm font-medium text-gray-700 mb-1">Change Visual Cue</label>
                <select id="bulk-edit-visual" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="[NO_CHANGE]">‚Äî Don't change ‚Äî</option>
                    <option value="">[None / Period Default]</option>
                    <option value="[CUSTOM_TEXT]">Custom Text/Color...</option>
                    <optgroup label="Default Visuals">
                        <option value="[DEFAULT] lunch">Lunch (Fork & Knife)</option>
                        <option value="[DEFAULT] passing">Passing Period (Walking Person)</option>
                    </optgroup>
                    <optgroup label="My Visuals" id="bulk-my-visuals-optgroup"></optgroup>
                    <optgroup label="Shared Visuals" id="bulk-shared-visuals-optgroup"></optgroup>
                </select>
                
                <!-- Visual Mode (only shown when visual is selected) -->
                <div id="bulk-visual-mode-container" class="mt-3 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Display Mode</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="bulk-visual-mode" value="before" class="mr-2" checked>
                            <span class="text-sm">Before</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="bulk-visual-mode" value="after" class="mr-2">
                            <span class="text-sm">After</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="bulk-visual-mode" value="both" class="mr-2">
                            <span class="text-sm">Both</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- V5.54.0: Time Shift Section -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="flex items-center gap-3 cursor-pointer mb-3">
                    <input type="checkbox" id="bulk-time-shift-enabled" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                    <span class="font-medium text-gray-700">Shift Time</span>
                </label>
                
                <div id="bulk-time-shift-controls" class="hidden">
                    <div class="flex items-center gap-2 flex-wrap">
                        <select id="bulk-time-shift-direction" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="later">Later (+)</option>
                            <option value="earlier">Earlier (‚àí)</option>
                        </select>
                        
                        <div class="flex items-center gap-1">
                            <input type="number" id="bulk-time-shift-hours" min="0" max="23" value="0" class="w-16 px-2 py-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">h</span>
                        </div>
                        
                        <div class="flex items-center gap-1">
                            <input type="number" id="bulk-time-shift-minutes" min="0" max="59" value="5" class="w-16 px-2 py-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">m</span>
                        </div>
                        
                        <div class="flex items-center gap-1">
                            <input type="number" id="bulk-time-shift-seconds" min="0" max="59" value="0" class="w-16 px-2 py-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">s</span>
                        </div>
                    </div>
                    
                    <p id="bulk-time-shift-warning" class="mt-3 text-sm text-amber-600 hidden">
                        ‚ö†Ô∏è <span id="bulk-time-shift-warning-text"></span>
                    </p>
                    
                    <p class="mt-2 text-xs text-gray-500">
                        Relative bells will adjust their offset. Static bells will shift their actual time.
                    </p>
                </div>
            </div>

            <p id="bulk-edit-status" class="text-blue-600 text-sm mb-4 hidden"></p>

            <div class="flex justify-end gap-3">
                <button type="button" id="bulk-edit-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="bulk-edit-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply to Selected</button>
            </div>
        </div>
    </div>

    <!-- **** NEW: Change Bell SOUND Modal (All Users) **** -->
    <div id="change-sound-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="change-sound-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Change Bell Sound</h3>

            <!-- Bell Info (Read-only) -->
            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <p class="text-sm font-medium text-gray-700">Bell:</p>
                <p id="change-sound-bell-name" class="text-lg font-semibold text-gray-900"></p>
                <p id="change-sound-bell-time" class="text-lg font-semibold text-gray-900"></p>
            </div>

            <div class="flex items-end gap-2">
                <div class="flex-grow">
                    <label for="change-sound-select" class="block text-sm font-medium text-gray-700">Sound</label>
                    <select id="change-sound-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <optgroup label="Default Sounds">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <option value="ellisBell.mp3" selected>Ellis Bell</option>
                        </optgroup>
                        <optgroup label="My Sounds" id="change-my-sounds-optgroup"></optgroup>
                        <optgroup label="Shared Sounds" id="change-shared-sounds-optgroup"></optgroup>
                    </select>
                </div>
                <button type="button" id="preview-change-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                    &#9654;
                </button>
            </div>
            <!-- END MODIFICATION -->

            <!-- Warning Message -->
            <div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 rounded">
                <p class="text-sm text-yellow-800">Are you sure you want to change this bell's sound? Your sound should be a brief but obvious indication of transition.</p>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="change-sound-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="change-sound-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Sound</button>
            </div>
        </form>
    </div>

    <!-- NEW: Confirm Linked Edit Modal -->
    <div id="confirm-linked-edit-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Update Linked Schedules?</h3>
            <p class="text-gray-700 mb-4">This bell was found in other schedules. Do you want to apply your edit to them as well?</p>

            <p class="text-sm font-medium text-gray-700 mb-2">Schedules containing this bell:</p>
            <div id="linked-schedule-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <!-- Linked schedules will be injected here -->
            </div>

            <p id="linked-edit-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button type="button" id="linked-edit-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="linked-edit-this-only" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Update This Schedule Only</button>
                <button type="button" id="linked-edit-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply to All Selected</button>
            </div>
        </div>
    </div>
    <!-- NEW: Confirm Delete Schedule Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Schedule</h3>
            <p id="confirm-delete-text" class="text-gray-700 mb-6">Are you sure you want to delete this schedule? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- **** NEW: Confirm Delete BELL Modal **** -->
    <!-- This replaces the browser's `confirm()` dialog -->
    <div id="confirm-delete-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Bell</h3>
            <p id="confirm-delete-bell-text" class="text-gray-700 mb-6">Are you sure you want to delete this bell?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-bell-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- **** NEW V4.91: Rename SHARED Schedule Modal (Admin) **** -->
    <div id="rename-shared-schedule-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="rename-shared-schedule-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Rename Shared Schedule</h3>

            <p class="text-gray-700 mb-4">
                Current Name: <strong id="rename-shared-old-name">...</strong>
            </p>

            <div>
                <label for="rename-shared-new-name" class="block text-sm font-medium text-gray-700">New Schedule Name</label>
                <input type="text" id="rename-shared-new-name" placeholder="e.g. A-Day Schedule" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <p id="rename-shared-schedule-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="rename-shared-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Name</button>
            </div>
        </form>
    </div>

    <!-- **** NEW: Confirm Delete AUDIO Modal **** -->
    <div id="confirm-delete-audio-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Delete Audio File</h3>
            <p id="confirm-delete-audio-text" class="text-gray-700 mb-4">Are you sure you want to delete this audio file?</p>

            <ul id="confirm-delete-audio-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-1 bg-gray-50 mb-6">
                <!-- Linked bells will be injected here -->
            </ul>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-audio-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-audio-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete Anyway</button>
            </div>
        </div>
    </div>

    <!-- **** NEW V4.97: Rename AUDIO Modal **** -->
    <div id="rename-audio-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="rename-audio-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Rename Audio File</h3>
            <p class="text-gray-700 mb-2">
                Original Filename: <strong id="rename-audio-old-name" class="block truncate text-sm bg-gray-100 p-2 rounded">...</strong>
            </p>
            <div class="mb-4">
                <label for="rename-audio-new-name" class="block text-sm font-medium text-gray-700">New Nickname</label>
                <input type="text" id="rename-audio-new-name" placeholder="e.g. My Favorite Bell" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-1">This nickname will be shown in all dropdown menus.</p>
            </div>
            <p id="rename-audio-status" class="text-blue-600 text-sm mt-4 hidden"></p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="rename-audio-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Nickname</button>
            </div>
        </form>
    </div>

    <!-- **** NEW: v5.27 - Rename Visual Modal **** -->
    <div id="rename-visual-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="rename-visual-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Rename Visual File</h3>
            <p class="text-gray-700 mb-2">
                Original Filename: <strong id="rename-visual-old-name" class="block truncate text-sm bg-gray-100 p-2 rounded">...</strong>
            </p>
            <div class="mb-4">
                <label for="rename-visual-new-name" class="block text-sm font-medium text-gray-700">New Nickname</label>
                <input type="text" id="rename-visual-new-name" placeholder="e.g. First Period Image" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-1">This nickname will be shown in all dropdown menus.</p>
            </div>
            <p id="rename-visual-status" class="text-blue-600 text-sm mt-4 hidden"></p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="rename-visual-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Nickname</button>
            </div>
        </form>
    </div>

    <!-- **** NEW: Nearby Bell Warning Modal (Req 1 - Custom Bells ONLY) **** -->
    <div id="nearby-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Nearby Bell Detected</h3>
            <p class="text-gray-700 mb-6">A bell named "<strong id="nearby-bell-name">...</strong>" is already scheduled for <strong id="nearby-bell-time">...</strong>. This is very close to your new time.</p>

            <p id="nearby-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <!-- Controls for Custom Bells (Req 1) -->
            <div id="nearby-bell-custom-controls" class="mt-6 flex justify-end gap-3">
                <button type="button" id="nearby-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="nearby-bell-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Confirm Action Anyway</button>
            </div>

            <!-- This is now handled by the new v3.02 modals -->
        </div>
    </div>

    <!-- **** NEW: Scenario 1, Step 1: Internal Conflict Warning Modal **** -->
    <div id="internal-conflict-warning-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4 text-yellow-800">Warning: Confusing Bell Time</h3>
            <p class="text-gray-700 mb-6">The time you selected (<strong id="internal-conflict-new-time">...</strong>) is within 60 seconds of an existing bell (<strong id="internal-conflict-existing-bell">...</strong>) in this *same* schedule. This would be very confusing for end users. We strongly suggest editing the existing bell first.</p>

            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button type="button" id="internal-conflict-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="internal-conflict-edit" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Edit Existing Bell</button>
                <button type="button" id="internal-conflict-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Confirm New Bell</button>
            </div>
        </div>
    </div>

    <!-- **** NEW: Scenario 1, Step 2: Internal Conflict Final Confirmation Modal **** -->
    <div id="internal-conflict-confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-60 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4 text-red-700">Are you sure?</h3>
            <p class="text-gray-700 mb-6">Are you absolutely positive you want to create a new bell at <strong id="internal-conflict-final-new-time">...</strong>, just <strong id="internal-conflict-final-diff">...</strong> seconds apart from the existing <strong id="internal-conflict-final-existing">...</strong> bell?</p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="internal-conflict-final-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="internal-conflict-final-create" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Yes, Create This Bell</button>
            </div>
        </div>
    </div>

    <!-- **** NEW: Scenario 2: External Conflict Resolution Modal **** -->
    <div id="external-conflict-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl"> <!-- Increased max-w -->
            <h3 class="text-xl font-medium mb-4">Similar Bell Found in Other Schedules</h3>
            <p class="text-gray-700 mb-4">One or more other shared schedules have bells with the same name very close to your new time of <strong id="external-conflict-new-time">...</strong>. Please select how you'd like to proceed.</p>

            <p class="text-sm font-medium text-gray-700 mb-2">Conflicting bells (select to "Create and Match"):</p>
            <div id="external-conflict-list" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2 mb-6 bg-gray-50">
                <!-- Conflicting bells will be injected here -->
                <p class="text-gray-500">Loading conflicts...</p>
            </div>

            <p id="external-conflict-status" class="text-blue-600 text-sm mt-4 mb-4 hidden"></p>

            <div class="mt-6 flex flex-col gap-3">
                <!-- Option 1: Match Existing (Disabled unless 1 is checked) -->
                <button type="button" id="external-conflict-match-existing" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>
                    Match Existing Bell Time (<span id="external-conflict-match-time">--:--</span>)
                </button>
                <!-- Option 2: Keep My Time (Always enabled) -->
                <button type="button" id="external-conflict-keep-new" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Keep My New Time (<span id="external-conflict-keep-time">--:--</span>) and Create a New Bell
                </button>
                <!-- Option 3: Create and Match (Disabled unless 1+ is checked) -->
                <button type="button" id="external-conflict-create-and-match" class="w-full px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 disabled:opacity-50" disabled>
                    Create a New Bell and Match Selected Bells to The New Time
                </button>
                <!-- Option 4: Cancel -->
                <button type="button" id="external-conflict-cancel" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 mt-2">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- MOVED: Personal Schedule Modals (v3.08) -->
    <div id="create-personal-schedule-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="create-personal-schedule-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">New Personal Schedule</h3>

            <p class="text-gray-700 mb-4">
                Base Schedule: <strong id="personal-base-schedule-name">...</strong>
            </p>

            <div>
                <label for="new-personal-schedule-name" class="block text-sm font-medium text-gray-700">New Schedule Name</label>
                <input type="text" id="new-personal-schedule-name" placeholder="e.g. My A-Day Schedule" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <p id="create-personal-schedule-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="create-personal-schedule-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Create</button>
            </div>
        </form>
    </div>

    <!-- V5.44: Create Custom Standalone Schedule Modal -->
    <div id="create-standalone-schedule-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="create-standalone-schedule-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-medium mb-4">Create Custom Standalone Schedule</h3>
            <p class="text-gray-700 mb-6">Create a blank schedule unlinked from any school bells. Perfect for cooking timers, personal routines, or special events.</p>
            
            <div class="mb-4">
                <label for="standalone-schedule-name" class="block text-sm font-medium text-gray-700 mb-1">Schedule Name</label>
                <input type="text" id="standalone-schedule-name" required placeholder="e.g., Thanksgiving Cooking"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            
            <p id="create-standalone-status" class="text-red-600 text-sm mt-4 hidden"></p>
            
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="create-standalone-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">Create Schedule</button>
            </div>
        </form>
    </div>

    <div id="confirm-delete-personal-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Personal Schedule</h3>
            <p id="confirm-delete-personal-text" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-personal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-personal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <div id="confirm-restore-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-medium mb-4">Restore Personal Schedule</h3>
            <p id="confirm-restore-text" class="text-gray-700 mb-4">Are you sure?</p>
            <!-- V5.46.2: Add name input for restored schedule -->
            <div class="mb-4">
                <label for="restore-schedule-name" class="block text-sm font-medium text-gray-700">Schedule Name</label>
                <input type="text" id="restore-schedule-name" placeholder="Enter schedule name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-1">Edit to give your restored schedule a different name</p>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="restore-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="restore-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Restore</button>
            </div>
        </div>
    </div>

    <div id="rename-personal-schedule-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="rename-personal-schedule-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Rename Personal Schedule</h3>

            <p class="text-gray-700 mb-4">
                Current Name: <strong id="rename-old-schedule-name">...</strong>
            </p>

            <div>
                <label for="rename-new-schedule-name" class="block text-sm font-medium text-gray-700">New Schedule Name</label>
                <input type="text" id="rename-new-schedule-name" placeholder="e.g. My A-Day Schedule" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <p id="rename-personal-schedule-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="rename-personal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Name</button>
            </div>
        </form>
    </div>
    
    <!-- V5.52.0: Countdown Warning Settings Modal -->
    <div id="warning-settings-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-medium mb-4">Countdown Warning Settings</h3>
            <p class="text-gray-600 mb-6">Get visual alerts as bells approach.</p>
            
            <!-- Enable Warnings -->
            <div class="mb-4">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="warning-enabled" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                    <span class="font-medium text-gray-700">Enable countdown warnings</span>
                </label>
            </div>
            
            <!-- Warning Time -->
            <div class="mb-4">
                <label for="warning-time" class="block text-sm font-medium text-gray-700 mb-1">Start warning at</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="warning-time" min="5" max="300" value="60" class="w-20 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <span class="text-gray-600">seconds before bell</span>
                </div>
            </div>
            
            <!-- Warning Style -->
            <div class="mb-4">
                <label for="warning-style" class="block text-sm font-medium text-gray-700 mb-1">Warning style</label>
                <select id="warning-style" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="pulse">Pulsing Glow</option>
                    <option value="color">Color Shift (Gray ‚Üí Amber ‚Üí Red)</option>
                    <option value="breathe">Breathing (Size Pulse)</option>
                    <option value="shake">Gentle Shake</option>
                    <option value="all">All Effects Combined</option>
                </select>
            </div>
            
            <!-- Warning Intensity -->
            <div class="mb-4">
                <label for="warning-intensity" class="block text-sm font-medium text-gray-700 mb-1">Intensity</label>
                <select id="warning-intensity" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="subtle">Subtle</option>
                    <option value="medium" selected>Medium</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            
            <!-- V5.52.1: Warning Colors -->
            <div class="mb-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Warning colors</p>
                <div class="grid grid-cols-3 gap-3">
                    <div class="text-center">
                        <label for="warning-color-subtle" class="block text-xs text-gray-500 mb-1">Subtle</label>
                        <input type="color" id="warning-color-subtle" value="#fbbf24" class="w-full h-10 rounded cursor-pointer border border-gray-300">
                    </div>
                    <div class="text-center">
                        <label for="warning-color-medium" class="block text-xs text-gray-500 mb-1">Medium</label>
                        <input type="color" id="warning-color-medium" value="#f97316" class="w-full h-10 rounded cursor-pointer border border-gray-300">
                    </div>
                    <div class="text-center">
                        <label for="warning-color-urgent" class="block text-xs text-gray-500 mb-1">Urgent</label>
                        <input type="color" id="warning-color-urgent" value="#ef4444" class="w-full h-10 rounded cursor-pointer border border-gray-300">
                    </div>
                </div>
                <button type="button" id="warning-reset-colors" class="mt-2 text-xs text-blue-600 hover:text-blue-800">Reset to defaults</button>
            </div>
            
            <!-- Apply To -->
            <div class="mb-6 space-y-2">
                <p class="text-sm font-medium text-gray-700">Apply warnings to:</p>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="warning-scheduled-bells" checked class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="text-gray-600">Scheduled bells</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="warning-quick-bells" checked class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="text-gray-600">Quick bells / timers</span>
                </label>
            </div>
            
            <!-- Preview -->
            <div class="mb-6 p-4 bg-gray-100 rounded-lg">
                <p class="text-sm font-medium text-gray-700 mb-2 text-center">Preview</p>
                <div id="warning-preview" class="mx-auto w-24 h-24 bg-gray-800 rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-gray-400">
                        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                    </svg>
                </div>
                <button type="button" id="warning-preview-btn" class="mt-3 w-full px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                    Test Warning Effect
                </button>
            </div>
            
            <div class="flex justify-end gap-3">
                <button type="button" id="warning-settings-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="warning-settings-save" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- END: Moved Modals (v3.08) -->
    
    <!-- V5.49.0: Kiosk Mode Toggle Button (fixed position) -->
    <button id="kiosk-toggle-btn" 
        class="fixed top-4 right-4 z-50 p-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors shadow-lg"
        title="Enter Kiosk Mode">
        <!-- Enter Kiosk Icon (monitor/fullscreen) -->
        <svg id="kiosk-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 3 21 3 21 9"></polyline>
            <polyline points="9 21 3 21 3 15"></polyline>
            <line x1="21" y1="3" x2="14" y2="10"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
        </svg>
        <!-- Exit Kiosk Icon (X) - hidden by default -->
        <svg id="kiosk-exit-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="4 14 10 14 10 20"></polyline>
            <polyline points="20 10 14 10 14 4"></polyline>
            <line x1="14" y1="10" x2="21" y2="3"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
        </svg>
    </button>
    
    <!-- Main Application -->
    <!-- MODIFIED in 4.49: Widened main container from 2xl to 4xl -->
    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        <header class="text-center mb-8 kiosk-hide">
            <h1 class="text-4xl font-bold text-blue-700">Ellis Web Bell 5.39.0</h1>
            <p class="text-lg text-gray-600">A real-time, synchronized bell schedule</p>


            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <!-- NEW: User display name -->
                <p id="user-display-name" class="text-gray-700"></p>
                <button id="signout-btn" class="w-full sm:w-auto px-4 py-1 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors hidden">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- MODIFIED: This card now shows countdown AND current time -->
        <!-- NEW in 4.44: Converted to 2-column grid for Visual Cues -->

        <div class="bg-white rounded-xl shadow-md mb-8 overflow-hidden p-4 md:p-6">

            <!-- MODIFIED in 4.49: Grid for Visual Cue (25%) and Clock (75%) -->

            <div class="grid grid-cols-1 md:grid-cols-5 items-center gap-4 md:gap-6">
                <!-- Column 1: Visual Cue (md:col-span-2 = 40%) -->

                <!-- V5.47.0: Added wrapper for PiP button positioning (button must be outside container that gets innerHTML replaced) -->
                <div id="visual-cue-wrapper" class="md:col-span-2 relative group w-full mx-auto">
                    <!-- V5.47.0: Pop Out Button (Document PiP) - positioned relative to wrapper -->
                    <button id="pip-toggle-btn" 
                        class="absolute top-2 right-2 p-2 bg-black bg-opacity-50 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-opacity-70"
                        title="Pop out timer (Picture-in-Picture)">
                        <!-- V5.49.3: Changed to PiP-style icon (small window over large) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <rect x="12" y="10" width="8" height="6" rx="1" ry="1" fill="currentColor"></rect>
                        </svg>
                    </button>
                    <!-- V5.52.1: Warning Settings Button - bottom left, hover only -->
                    <button id="settings-toggle-btn" 
                        class="absolute bottom-2 left-2 p-2 bg-black bg-opacity-50 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-opacity-70"
                        title="Warning Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                    <!-- Inner container - this is what gets updated by JS -->
                    <div id="visual-cue-container" class="bg-gray-800 flex items-center justify-center min-h-[150px] aspect-square rounded-lg overflow-hidden">
                        <!-- Default SVG or Image will be injected here by JS -->
                        <svg id="default-visual-cue" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-24 h-24 text-gray-500">
                            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                        </svg>
                    </div>
                </div>

                <!-- Column 2: Countdown / Clock (md:col-span-3 = 75%) -->

                <div class="md:col-span-3 p-2 flex flex-col justify-center">
                    <!-- MOVED V4.98: Live Clock Sentence -->
                    <div id="live-clock-sentence" class="text-2xl font-medium text-gray-600 tabular-nums text-center md:text-left">
                        Loading...
                    </div>

                    <!-- Line 2: "HH:MM:SS" (countdown) -->
                    <div id="countdown-display" class="text-6xl md:text-8xl font-bold text-gray-800 tabular-nums my-2 text-center md:text-left">
                        --:--
                    </div>

                    <!-- Line 3: "until XXBELLXX" -->
                    <div id="next-bell-sentence" class="text-2xl font-medium text-gray-600 text-center md:text-left">
                        until the next bell.
                    </div>

                    <div id="next-bell-info" class="text-lg text-gray-500 mt-2 text-center md:text-left">
                        <!-- JS will populate this -->
                    </div>

                    <!-- MOVED V4.98: Status Footer -->
                    <!-- MODIFIED V5.42: Added Cancel Timer button to status row -->
                    <!-- MODIFIED V5.47.13: Added Skip Bell and Unskip buttons -->
                    <!-- V5.49: Hidden in kiosk mode -->
                    <div class="flex justify-between items-center text-gray-500 text-lg mt-4 pt-4 border-t border-gray-100 kiosk-hide">
                        <div class="text-center md:text-left">
                            Status: <span id="status-message" class="font-medium text-gray-700">Initializing...</span>
                        </div>
                        <!-- Action buttons - right aligned in status row -->
                        <div class="flex gap-2">
                            <button id="skip-bell-btn" class="px-4 py-2 bg-yellow-500 text-white text-sm rounded-lg hover:bg-yellow-600 hidden" title="Skip the next scheduled bell (just this once)">
                                Skip Bell
                            </button>
                            <button id="unskip-bell-btn" class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 hidden">
                                Unskip
                            </button>
                            <button id="cancel-quick-bell-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 hidden">
                                Cancel Timer
                            </button>
                        </div>
                    </div>
                </div>

            </div> <!-- End Grid (Graphic/Countdown) -->

        </div>

        <!-- **** NEW: Quick Bell Section **** -->
        <!-- V5.49: Hidden in kiosk mode -->
        <div id="quickBellControls" class="p-4 bg-white rounded-xl shadow-md mb-8 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 kiosk-hide">
            <!-- 1. Label -->
            <span class="font-semibold text-gray-700 flex-shrink-0">Quick Bell:</span>

            <!-- 2. Sound Dropdown with Preview -->
            <!-- 5.14: Dynamically change size to factor in quick bells -->
            <!-- V5.49: Added preview button -->
			<div class="flex items-center gap-2 w-full sm:w-auto sm:flex-1 sm:min-w-0">
                <!-- This select will be populated by JS to match the others -->
                <select id="quickBellSoundSelect" class="flex-1 min-w-0 truncate px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 h-11">
                    <optgroup label="Default Sounds">
                        <option value="Bell">Bell</option>
                        <option value="Chime">Chime</option>
                        <option value="Beep">Beep</option>
                        <optgroup label="My Sounds" id="quick-my-sounds-optgroup"></optgroup>
                    <optgroup label="Shared Sounds" id="quick-shared-sounds-optgroup"></optgroup>
                </select>
                <button type="button" id="preview-quick-bell-sound" class="w-11 h-11 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                    ‚ñ∂
                </button>
            </div>

            <!-- 3. Button Container -->
            <div class="flex flex-wrap gap-2 items-center flex-shrink-0">
                <!-- ADDED: The 'quick-bell-btn' class as a JS hook -->
                <button data-minutes="1" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95 h-11">1</button>
                <button data-minutes="2" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95 h-11">2</button>
                <button data-minutes="3" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95 h-11">3</button>
                <button data-minutes="5" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95 h-11">5</button>
                <button data-minutes="10" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95 h-11">10</button>
                <button data-minutes="15" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95 h-11">15</button>
            	<!-- MOVED 5.12 -->

                <div id="custom-quick-bell-separator" class="hidden h-11 border-l-2 border-gray-300 mx-1"></div>

                <div id="custom-quick-bells-container" class="flex flex-wrap gap-2">
                    <!-- Custom buttons will be injected here -->
                </div>
			</div>
        </div>
        <!-- **** END NEW: Quick Bell Section **** -->

        <!-- Combined Bell Schedule List -->
        <!-- V5.49: Hidden in kiosk mode -->
        <div class="kiosk-hide">
            <!-- NEW: Mute & Collapse Controls added -->
            <div class="flex justify-between items-center mb-4">
                 <h2 id="schedule-title" class="text-2xl font-semibold">Current Schedule</h2>
                 <div class="flex-shrink-0 flex gap-2">
                     <!-- NEW in 4.49: Collapse/Expand Buttons -->
                     <button id="collapse-all-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Collapse All</button>
                     <button id="expand-all-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Expand All</button>
                     <!-- End Collapse/Expand -->
                     <button id="mute-all-list-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Mute All</button>
                     <button id="unmute-all-list-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Unmute All</button>
                     <!-- V5.46.0: Bulk Edit Toggle -->
                     <button id="bulk-edit-toggle-btn" class="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 hidden">Bulk Edit</button>
                 </div>
            </div>
            <div id="combined-bell-list" class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <!-- Bells will be injected here by JavaScript -->
                <div class="p-8 text-center text-gray-500">
                    Loading schedule...
                </div>
            </div>
        </div>

        <!-- Schedule Selector -->
        <!-- V5.49: Hidden in kiosk mode -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8 kiosk-hide">
            <!-- V5.44.8: Standardized header format -->
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Active Schedule</h3>
            
            <div class="flex justify-between items-center mb-2">
                <label for="schedule-selector" class="block text-sm font-medium text-gray-700">Select Schedule</label>
                <!-- MODIFIED: Disabled by default, enabled via JS for admins -->
                <button id="admin-toggle" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors opacity-50 cursor-not-allowed" disabled title="Sign in to see admin options">
                    Toggle Admin
                </button>
            </div>

            <!-- NEW (FIXED): Re-inserted the missing select element -->
            <select id="schedule-selector" class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                <option value="">Loading schedules...</option>
            </select>
            
            <!-- V5.44: Standalone Schedule Badge -->
            <div id="standalone-schedule-badge" class="hidden mt-2 px-3 py-2 bg-orange-100 text-orange-700 text-sm font-medium rounded-lg text-center">
                üéØ Custom Standalone Schedule ‚Äî No shared bells, fully customizable
            </div>

            <!-- V5.44.8: Moved Rename Schedule here -->
            <button type="button" id="rename-personal-schedule-btn" class="auth-required w-full mt-4 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Rename Schedule
            </button>

            <button id="create-personal-schedule-btn" class="auth-required w-full mt-2 px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Copy as Personal Schedule
            </button>
            
            <!-- V5.44: Create Custom Standalone Schedule -->
            <button id="create-standalone-schedule-btn" class="auth-required w-full mt-2 px-4 py-2 bg-orange-600 text-white font-medium rounded-lg shadow-md hover:bg-orange-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Create Custom Standalone Schedule
            </button>
        </div>



        <!-- NEW: Admin Zone for creating schedules and adding bells -->
        <!-- V5.49: Hidden in kiosk mode -->
        <div class="admin-control bg-white p-6 rounded-xl shadow-md mb-8 space-y-6 kiosk-hide">
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Admin Zone</h3>

            <!-- Create New Schedule Form -->
            <form id="create-schedule-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <label for="new-schedule-name" class="block text-sm font-medium text-gray-700 mb-1">Create New Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-schedule-name" placeholder="New Schedule Name" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700">
                        Create
                    </button>
                </div>
            </form>

            <!-- NEW: Add Bell to THIS Schedule Form -->
            <form id="add-shared-bell-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to This Schedule</label>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="shared-bell-period" class="block text-sm font-medium text-gray-700 mb-1">Period</label>

                        <select id="shared-bell-period" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- Options populated by JS -->
                            <option value="">Select Period...</option>
                        </select>
                    </div>
                    <div>
                        <label for="shared-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="shared-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="shared-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="shared-bell-name" placeholder="e.g. 1st Period Start" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="shared-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>

                        <select id="shared-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <optgroup label="Default Sounds">
                                <option value="Bell">Bell</option>
                                <option value="Chime">Chime</option>
                                <option value="Beep">Beep</option>
                                <option value="Alarm">Alarm</option>
                                <option value="ellisBell.mp3" selected>Ellis Bell</option>
                            </optgroup>
                            <optgroup label="My Sounds" id="shared-my-sounds-optgroup"></optgroup>
                            <optgroup label="Shared Sounds" id="shared-shared-sounds-optgroup"></optgroup>
                        </select>
                    </div>
                    <!-- MODIFIED: Changed button text from "Play" to icon -->
                    <button type="button" id="preview-shared-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                        &#9654;
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Shared Bell
                    </button>
                </div>
                <p id="add-shared-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- Add Bell to Schedules Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to Multiple Schedules</label>
                <button type="button" id="show-add-bell-modal-btn" class="w-full px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700">
                    Add Bell to Schedules...
                </button>
            </div>

            <!-- MOVED: Delete Selected Schedule Button -->

            <div class="border-t pt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rename Current Schedule</label>
                    <button type="button" id="rename-schedule-btn" class="w-full px-4 py-2 bg-yellow-500 text-white font-medium rounded-lg shadow-md hover:bg-yellow-600 transition-colors">
                        Rename Selected Schedule
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Schedule</label>
                    <button type="button" id="delete-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors">
                        Delete Selected Schedule
                    </button>
                </div>
            </div>

            <!-- NEW: Import/Export Section -->
            <div class="border-t pt-6 space-y-4">
                <h4 class="text-lg font-medium text-gray-800">Backup & Restore</h4>


                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Top Row: Current Schedule -->
                    <button type="button" id="export-current-schedule-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Export Current Schedule
                    </button>
                    <button type="button" id="import-current-schedule-btn" class="w-full px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Import & Overwrite Current
                    </button>

                    <!-- Bottom Row: All Schedules -->
                    <button type="button" id="export-schedules-btn" class="w-full px-4 py-2 bg-blue-700 text-white font-medium rounded-lg shadow-md hover:bg-blue-800 transition-colors">
                        Export ALL Shared Schedules
                    </button>
                    <button type="button" id="import-schedules-btn" class="w-full px-4 py-2 bg-gray-700 text-white font-medium rounded-lg shadow-md hover:bg-gray-800 transition-colors">
                        Import & Overwrite ALL
                    </button>
                </div>

                <!-- Hidden file inputs -->
                <input type="file" id="import-file-input" accept="application/json">
                <input type="file" id="import-current-file-input" accept="application/json" class="hidden">

                <p id="import-status" class="text-blue-600 text-sm mt-2 hidden"></p>
            </div>

        </div>

        <!-- V5.49: Hidden in kiosk mode -->
        <div class="auth-required mt-12 kiosk-hide"> <!-- Hidden for anonymous users -->
            <!-- DELETED in 4.40: Removed the old H2 and 'add-personal-bell-form'. -->
            <!-- This functionality is replaced by the in-period '+ Bell' button -->
            <!-- and the new 'Multi-Add' feature. -->

            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">My Personal Schedule Manager</h3>


                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <button type="button" id="show-custom-quick-bell-manager-btn" class="w-full px-4 py-3 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span class="font-semibold">Custom Quick Bells</span>
                        <span class="block text-sm opacity-90">Set up to 4 personalized timers with custom icons.</span>
                    </button>
                    <button type="button" id="multi-add-relative-btn" class="w-full px-4 py-3 bg-purple-600 text-white font-medium rounded-lg shadow-md hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span class="font-semibold">Add Multi-Period Bell</span>
                        <span class="block text-sm opacity-90">Add one relative bell (e.g., "Clean up") to many periods.</span>
                    </button>
                </div>

                <!-- V5.44.8: Passing Period Visual + New Period in same row -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <button type="button" id="passing-period-visual-btn" 
                            class="w-full px-4 py-3 bg-teal-600 text-white font-medium rounded-lg shadow-md hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" 
                            disabled>
                        <span class="font-semibold">Passing Period Visual</span>
                        <span class="block text-sm opacity-90">Set the icon shown between periods.</span>
                    </button>
                    <button type="button" id="new-period-btn" class="w-full px-4 py-3 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span class="font-semibold">+ New Period</span>
                        <span class="block text-sm opacity-90">Create a new period with start/end bells.</span>
                    </button>
                </div>

                <!-- ROW: Backup / Restore (2-Column Grid) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 border-t pt-4 mb-4">
                    <button type="button" id="backup-personal-schedule-btn" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Download Backup (JSON)
                    </button>
                    <button type="button" id="restore-personal-schedule-btn" class="px-4 py-2 bg-yellow-500 text-black font-medium rounded-lg shadow-md hover:bg-yellow-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Load/Overwrite from Backup
                    </button>
                </div>

                <!-- ROW: Delete -->
                <div class="border-t pt-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Personal Schedule</label>
                    <button type="button" id="delete-personal-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Delete Selected Personal Schedule
                    </button>
                </div>
            </div>
        </div>

        <div id="relative-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <form id="relative-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-medium mb-4">Add Relative Bell</h3>
                <p class="text-gray-700 mb-6">Create a bell relative to the start or end of the period <strong id="relative-period-name">...</strong>.</p>

                <div class="mb-4">
                    <label for="relative-anchor-bell" class="block text-sm font-medium text-gray-700 mb-1">Parent Bell</label>
                    <select id="relative-anchor-bell" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">                        <!-- Options will be populated by JS -->
                        <option value="">Loading bells...</option>
                    </select>
                </div>

                <!-- Time Direction -->
                <div class="mb-4">
                    <label for="relative-direction" class="block text-sm font-medium text-gray-700 mb-1">Time Direction</label>
                    <select id="relative-direction" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="before">Before Parent</option>
                        <option value="after">After Parent</option>
                    </select>
                </div>

                <!-- Offset Time Input - V5.44.1: Added hours for longer durations -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div>
                        <label for="relative-hours" class="block text-sm font-medium text-gray-700 mb-1">Hours</label>
                        <input type="number" id="relative-hours" value="0" min="0" max="23" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="relative-minutes" class="block text-sm font-medium text-gray-700 mb-1">Minutes</label>
                        <input type="number" id="relative-minutes" value="0" min="0" max="59" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="relative-seconds" class="block text-sm font-medium text-gray-700 mb-1">Seconds</label>
                        <input type="number" id="relative-seconds" value="0" min="0" max="59" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Calculated Time Preview -->
                <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Calculated Time</label>
                    <span id="calculated-time" class="text-lg font-semibold text-blue-600">--:--:-- --</span>
                </div>

                <!-- Convert to Static (Edit Mode Only) -->
                <div id="convert-to-static-container" class="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="convert-to-static-checkbox" class="mr-2 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">Convert to Static Bell</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">This will set the bell's time to <strong id="convert-to-static-time">--:--:-- --</strong> and remove the relative dependency.</p>
                </div>

                <!-- Bell Name and Sound -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="relative-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="relative-bell-name" placeholder="e.g. Hamburger Time" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="relative-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <!-- V5.49: Added preview button -->
                        <div class="flex items-center gap-2">
                            <select id="relative-bell-sound" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                            <button type="button" id="preview-relative-bell-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                                ‚ñ∂
                            </button>
                        </div>
                    </div>
                </div>

				<!-- NEW 5.19 Visual Cue Picker -->
				<div class="mb-4">
				    <label for="relative-bell-visual" class="block text-sm font-medium text-gray-700 mb-1">Visual Cue</label>
				    <select id="relative-bell-visual" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
				        <option value="">[None / Period Default]</option>
				        <option value="[UPLOAD]">Upload Image...</option>
				        <option value="[CUSTOM_TEXT]">Custom Text/Color...</option>
				        <!-- Options will be populated by JS -->
				    </select>
				</div>

				<!-- Visual Display Mode & Preview (Two Column) -->
				<div class="visual-mode-preview-grid">
				    <!-- Left Column: Visual Display Mode -->
				    <div>
				        <label class="block text-sm font-medium text-gray-700 mb-2">Visual Display</label>
				        <div class="visual-mode-stack">
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="relative-visual-mode" value="none" checked class="mr-2">
				                <span class="text-sm">None</span>
				            </label>
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="relative-visual-mode" value="before" class="mr-2">
				                <span class="text-sm">Before</span>
				            </label>
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="relative-visual-mode" value="after" class="mr-2">
				                <span class="text-sm">After</span>
				            </label>
				        </div>
				        <p class="text-xs text-gray-500 mt-2">
				            <strong>Before:</strong> Show while counting down<br>
				            <strong>After:</strong> Show after bell rings
				        </p>
				    </div>
				    
				    <!-- Right Column: Preview -->
				    <div>
				        <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
				        <div id="relative-bell-visual-preview-full" class="visual-preview-full">
				            <span class="visual-preview-placeholder">Select visual</span>
				        </div>
				    </div>
				</div>

                <p id="relative-bell-status" class="text-red-600 text-sm mt-4 hidden"></p>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="relative-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Bell</button>
                </div>
            </form>
        </div>

        <!-- **** NEW: v4.28 - Add Bell Type (Choice) Modal **** -->
        <div id="add-bell-type-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                <h3 class="text-xl font-medium mb-4">Add Bell</h3>
                <p class="text-gray-700 mb-6">What type of bell do you want to add to <strong id="add-bell-type-period-name">...</strong>?</p>

                <div class="mt-6 flex flex-col gap-3">
                    <button type="button" id="add-bell-type-static" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <span class="font-semibold">Static Time Bell</span>
                        <span class="block text-sm opacity-90">Set a specific time (e.g., 10:30:00 AM)</span>
                    </button>
                    <button type="button" id="add-bell-type-relative" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <span class="font-semibold">Relative Time Bell</span>
                        <span class="block text-sm opacity-90">Set time based on another bell (e.g., 5 min before)</span>
                    </button>
                    <button type="button" id="add-bell-type-cancel" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 mt-2">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- **** NEW: v4.28 - Add Static Bell Modal **** -->
        <div id="add-static-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <form id="add-static-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-medium mb-4">Add Static Bell</h3>
                <p class="text-gray-700 mb-6">Adding a new bell to the period <strong id="add-static-period-name">...</strong>.</p>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="add-static-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                        <input type="time" id="add-static-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="add-static-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                        <input type="text" id="add-static-bell-name" placeholder="e.g. My Reminder" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="flex items-end gap-2">
                    <div class="flex-grow">
                        <label for="add-static-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                        <select id="add-static-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <button type="button" id="preview-add-static-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                        &#9654;
                    </button>
                </div>

				<!-- NEW 5.19 Visual Cue Picker -->
				<div class="mb-4">
				    <label for="add-static-bell-visual" class="block text-sm font-medium text-gray-700 mb-1">Visual Cue</label>
				    <select id="add-static-bell-visual" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
				        <option value="">[None / Period Default]</option>
				        <option value="[UPLOAD]">Upload Image...</option>
				        <option value="[CUSTOM_TEXT]">Custom Text/Color...</option>
				        <!-- Options will be populated by JS -->
				    </select>
				</div>

				<!-- Visual Display Mode - Two Column Layout -->
				<!-- MODIFIED V5.42: Use centralized CSS classes -->
				<div class="visual-mode-preview-grid">
				    <!-- Left Column: Visual Display Mode -->
				    <div>
				        <label class="block text-sm font-medium text-gray-700 mb-2">Visual Display</label>
				        <div class="visual-mode-stack">
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="add-static-visual-mode" value="none" checked class="mr-2">
				                <span class="text-sm">None</span>
				            </label>
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="add-static-visual-mode" value="before" class="mr-2">
				                <span class="text-sm">Before</span>
				            </label>
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="add-static-visual-mode" value="after" class="mr-2">
				                <span class="text-sm">After</span>
				            </label>
				        </div>
				        <p class="text-xs text-gray-500 mt-2">
				            <strong>Before:</strong> Show while counting down<br>
				            <strong>After:</strong> Show after bell rings
				        </p>
				    </div>
				    
				    <!-- Right Column: Preview -->
				    <div>
				        <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
				        <div id="add-static-bell-visual-preview" class="visual-preview-full">
				            <span class="visual-preview-placeholder">Select visual</span>
				        </div>
				    </div>
				</div>

                <p id="add-static-bell-status" class="text-red-600 text-sm mt-4 hidden"></p>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="add-static-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Bell</button>
                </div>
            </form>
        </div>

        <!-- **** NEW: v4.12.2 - Orphan Bell Handling Modal **** -->
        <div id="orphan-handling-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-60 hidden">            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-xl font-medium mb-4 text-red-700">Warning: This is a Parent Bell!</h3>
                <p class="text-gray-700 mb-4">You are trying to delete "<strong id="orphan-parent-name">...</strong>". This bell is the "parent" for the following child bell(s):</p>

                <div id="orphan-child-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-1 bg-gray-50 mb-6">
                    <!-- Child bells will be injected here by JS -->
                </div>

                <p class="text-gray-700 mb-6">How do you want to handle these "orphaned" bells?</p>

                <div class_="mt-6 flex flex-col gap-3">
                    <button type="button" id="orphan-action-independent" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Make Children Independent (Keep their current time)
                    </button>
                    <button type="button" id="orphan-action-delete" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Delete Parent AND All Child Bells
                    </button>
                    <button type="button" id="orphan-action-cancel" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 mt-2">
                        Cancel (Do nothing)
                    </button>
                </div>
            </div>
        </div>

        <!-- DELETED in 4.44: Replaced by 'edit-period-details-modal' -->
        <!-- <div id="rename-period-modal" ...> ... </div> -->

        <!-- **** NEW: v4.44 - Confirm Delete VISUAL Modal **** -->
        <div id="confirm-delete-visual-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-xl font-medium mb-4">Delete Visual File</h3>
                <p id="confirm-delete-visual-text" class="text-gray-700 mb-6">Are you sure you want to delete this visual? Any periods using it will revert to the default.</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="delete-visual-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="button" id="delete-visual-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete Anyway</button>
                </div>
            </div>
        </div>

        <!-- **** NEW: v4.44 - Edit Period Details Modal (Replaces Rename Modal) **** -->
        <div id="edit-period-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <form id="edit-period-details-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-2xl font-medium mb-6">Edit Period Details</h3>

                <p class="text-gray-700 mb-4">
                    Original Name: <strong id="edit-period-old-name">...</strong>
                </p>

                <div class="mb-4">
                    <label for="edit-period-new-name" class="block text-sm font-medium text-gray-700">Period Nickname</label>
                    <input type="text" id="edit-period-new-name" placeholder="e.g. My Science Block" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label for="edit-period-image-select" class="block text-sm font-medium text-gray-700">Visual Cue</label>
                    <select id="edit-period-image-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Options populated by JS -->
                        <option value="">Loading visuals...</option>
                    </select>
                </div>

                <!-- NEW in 4.51: Two-Column Preview Layout (Full Size + Icon Size) -->
                <!-- MODIFIED V5.42: Use centralized CSS classes -->
                <div class="visual-dual-preview-grid">
                    <!-- Column 1: Full Size Square Preview -->
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Size</label>
                        <div id="edit-period-image-preview-full" class="visual-preview-full">
                            <span class="visual-preview-placeholder">Preview</span>
                        </div>
                    </div>
                    <!-- Column 2: Period Preview Size (Small Icon) -->
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Period Preview Size</label>
                        <div id="edit-period-image-preview-icon" class="visual-preview-icon-wrapper">
                            <span class="visual-preview-placeholder text-xs">Icon</span>
                        </div>
                    </div>
                </div>

                <p id="edit-period-status-msg" class="text-blue-600 text-sm mt-4 hidden"></p>
                <!-- NEW in 4.58: Delete button for custom periods -->
                <div class="mt-6 flex justify-between gap-3">
                    <button type="button" id="delete-custom-period-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 hidden">
                        Delete Period
                    </button>
                    <div class="flex gap-3 ml-auto">
                        <button type="button" id="edit-period-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- **** NEW: v4.57 - New Period Modal (Static/Relative) **** -->
        <div id="new-period-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <form id="new-period-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-medium mb-6">Create New Personal Period</h3>

                <!-- Period Name and Visual -->
                <div class="mb-4">
                    <label for="new-period-name" class="block text-sm font-medium text-gray-700">Period Name</label>
                    <input type="text" id="new-period-name" placeholder="e.g. Morning Duty" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-6">
                    <label for="new-period-image-select" class="block text-sm font-medium text-gray-700">Visual Cue</label>
                    <select id="new-period-image-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Options populated by JS -->
                    </select>
                    
                    <!-- Visual Preview (Two Column Layout) -->
                    <!-- MODIFIED V5.42: Use centralized CSS classes -->
                    <div class="visual-dual-preview-grid">
                        <div class="text-center">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Full Preview</label>
                            <div id="new-period-image-preview-full" class="visual-preview-full">
                                <span class="visual-preview-placeholder text-xs">No visual selected</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Icon Preview</label>
                            <div id="new-period-image-preview-icon" class="visual-preview-icon-wrapper">
                                <span class="visual-preview-placeholder text-xs">No visual selected</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Static/Relative Toggle -->
                <div class="mb-6 flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="new-period-type" value="static" id="new-period-type-static" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">Static Time Period</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="new-period-type" value="relative" id="new-period-type-relative" class="h-4 w-4 text-purple-600 focus:ring-purple-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">Relative Time Period</span>
                    </label>
                </div>

                <!-- START BELL CONFIGURATION -->
                <div class="border-t pt-4 mb-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Start Bell (Anchor)</h4>
                    <!-- Static Inputs -->

                    <div id="new-period-start-static" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1">
                            <label for="new-period-start-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                            <input type="time" id="new-period-start-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="new-period-start-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                            <!-- V5.49: Added preview button -->
                            <div class="flex items-center gap-2 mt-1">
                                <select id="new-period-start-sound" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <!-- Populated by JS -->
                                </select>
                                <button type="button" id="preview-new-period-start-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                                    ‚ñ∂
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Relative Inputs - V5.44.7: Three-row layout with aligned pairs -->
                    <div id="new-period-start-relative" class="hidden space-y-3">
                        <!-- Row 1: Anchor Period + Hours -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="new-period-start-parent" class="block text-sm font-medium text-gray-700">Anchor Period</label>
                                <select id="new-period-start-parent" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <!-- Base Periods populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="new-period-start-hours" class="block text-sm font-medium text-gray-700">Hours</label>
                                <input type="number" id="new-period-start-hours" value="0" min="0" max="23" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        <!-- Row 2: Anchor Bell + Minutes -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="new-period-start-anchor-type" class="block text-sm font-medium text-gray-700">Anchor Bell</label>
                                <select id="new-period-start-anchor-type" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="period_start">Period Start</option>
                                    <option value="period_end">Period End</option>
                                </select>
                            </div>
                            <div>
                                <label for="new-period-start-minutes" class="block text-sm font-medium text-gray-700">Minutes</label>
                                <input type="number" id="new-period-start-minutes" value="0" min="0" max="59" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        <!-- Row 3: Direction + Seconds -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="new-period-start-direction" class="block text-sm font-medium text-gray-700">Direction</label>
                                <select id="new-period-start-direction" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="before">Before</option>
                                    <option value="after">After</option>
                                </select>
                            </div>
                            <div>
                                <label for="new-period-start-seconds" class="block text-sm font-medium text-gray-700">Seconds</label>
                                <input type="number" id="new-period-start-seconds" value="0" min="0" max="59" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>

                        <div>
                            <label for="new-period-start-sound-relative" class="block text-sm font-medium text-gray-700">Sound</label>
                            <!-- V5.49: Added preview button -->
                            <div class="flex items-center gap-2 mt-1">
                                <select id="new-period-start-sound-relative" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <!-- Populated by JS -->
                                </select>
                                <button type="button" id="preview-new-period-start-sound-relative" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                                    ‚ñ∂
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- END BELL CONFIGURATION -->
                <div class="border-t pt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">End Bell (Anchor)</h4>
                    <!-- Static Inputs -->

                    <div id="new-period-end-static" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1">
                            <label for="new-period-end-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                            <input type="time" id="new-period-end-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="new-period-end-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                            <!-- V5.49: Added preview button -->
                            <div class="flex items-center gap-2 mt-1">
                                <select id="new-period-end-sound" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <!-- Populated by JS -->
                                </select>
                                <button type="button" id="preview-new-period-end-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                                    ‚ñ∂
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Relative Inputs - V5.44.7: Three-row layout with aligned pairs -->
                    <div id="new-period-end-relative" class="hidden space-y-3">
                        <!-- Row 1: Anchor Period + Hours -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="new-period-end-parent" class="block text-sm font-medium text-gray-700">Anchor Period</label>
                                <select id="new-period-end-parent" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <!-- Base Periods populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="new-period-end-hours" class="block text-sm font-medium text-gray-700">Hours</label>
                                <input type="number" id="new-period-end-hours" value="0" min="0" max="23" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        <!-- Row 2: Anchor Bell + Minutes -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="new-period-end-anchor-type" class="block text-sm font-medium text-gray-700">Anchor Bell</label>
                                <select id="new-period-end-anchor-type" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="period_start">Period Start</option>
                                    <option value="period_end">Period End</option>
                                </select>
                            </div>
                            <div>
                                <label for="new-period-end-minutes" class="block text-sm font-medium text-gray-700">Minutes</label>
                                <input type="number" id="new-period-end-minutes" value="0" min="0" max="59" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        <!-- Row 3: Direction + Seconds -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="new-period-end-direction" class="block text-sm font-medium text-gray-700">Direction</label>
                                <select id="new-period-end-direction" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="before">Before</option>
                                    <option value="after">After</option>
                                </select>
                            </div>
                            <div>
                                <label for="new-period-end-seconds" class="block text-sm font-medium text-gray-700">Seconds</label>
                                <input type="number" id="new-period-end-seconds" value="0" min="0" max="59" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>

                        <div>
                            <label for="new-period-end-sound-relative" class="block text-sm font-medium text-gray-700">Sound</label>
                            <!-- V5.49: Added preview button -->
                            <div class="flex items-center gap-2 mt-1">
                                <select id="new-period-end-sound-relative" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <!-- Populated by JS -->
                                </select>
                                <button type="button" id="preview-new-period-end-sound-relative" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                                    ‚ñ∂
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <p id="new-period-status" class="text-red-600 text-sm mt-4 hidden"></p>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="new-period-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="new-period-submit-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Create Period</button>
                </div>
            </form>
        </div>
        <div id="user-message-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                <h3 id="user-message-title" class="text-xl font-medium mb-4">Notification</h3>
                <p id="user-message-text" class="text-gray-700 mb-6">...</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="user-message-ok" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">OK</button>
                </div>
            </div>
        </div>

        <!-- **** NEW: v4.58 - General User Confirmation Modal (For Deletion/Irreversible Actions) **** -->
        <div id="user-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-60 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h3 id="user-confirmation-title" class="text-xl font-semibold text-gray-900 mb-3">Confirm Action</h3>
                <p id="user-confirmation-text" class="text-gray-700 mb-6">Are you sure you want to proceed?</p>
                <div class="flex justify-end space-x-3">
                    <button id="user-confirmation-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="user-confirmation-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
                </div>
            </div>
        </div>

        <!-- **** NEW: v4.60.7 - Custom Text Visual Modal **** -->

        <div id="custom-text-visual-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden" style="z-index: 90;">

            <form id="custom-text-visual-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-medium mb-4">Custom Text Visual</h3>
                <p class="text-gray-700 mb-6">Enter custom text (1-3 characters) and choose colors.</p>

                <!-- Custom Text/Color Area - Now always visible since modal is only for custom text -->
                <div id="custom-text-color-container" class="mb-4">
                    <div class="mb-4 text-center">
                        <label for="custom-text-input" class="block text-sm font-medium text-gray-700 mb-1">Custom Text (1-3 Chars)</label>
                        <input type="text" id="custom-text-input" placeholder="ABC" required maxlength="3" class="text-4xl font-extrabold tracking-widest text-center w-32 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <label for="custom-text-color" class="block text-sm font-medium text-gray-700 mb-1">Text Color</label>
                            <input type="color" id="custom-text-color" value="#FFFFFF" class="w-16 h-10 p-0 border-none rounded-md cursor-pointer mx-auto block">
                        </div>
                        <div class="text-center">
                            <label for="custom-text-bg-color" class="block text-sm font-medium text-gray-700 mb-1">Background</label>
                            <input type="color" id="custom-text-bg-color" value="#4338CA" class="w-16 h-10 p-0 border-none rounded-md cursor-pointer mx-auto block">
                        </div>
                    </div>
                </div>

                <!-- Previews - FIX V5.42: Labels now dynamic based on context -->
                <div class="visual-dual-preview-grid mt-4">
                     <div class="text-center">
                        <label id="custom-text-preview-full-label" class="block text-sm font-medium text-gray-700 mb-1">Full Size Preview</label>
                        <div id="quick-bell-visual-preview-full" class="visual-preview-full mx-auto">
                            <span class="visual-preview-placeholder text-xs">Preview</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <label id="custom-text-preview-icon-label" class="block text-sm font-medium text-gray-700 mb-1">Icon Preview</label>
                        <!-- V5.42: Icon preview - will be styled based on context (circle for period, square for button) -->
                        <div id="quick-bell-visual-preview-icon" class="visual-preview-icon-wrapper mx-auto">
                            <div id="quick-bell-visual-preview-icon-inner" class="visual-preview-icon-circle bg-gray-200">
                                <span class="visual-preview-placeholder text-xs">Icon</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="custom-text-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="custom-text-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Visual</button>
                </div>
            </form>
        </div>

        <!-- **** NEW: v4.75 - Reusable Visual Upload Modal **** -->
        <div id="upload-visual-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-70 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-2xl font-medium mb-6">Upload New Visual</h3>

                <!-- This is the content moved from the visual-manager-panel -->
                <div>
                    <p class="text-sm text-gray-600 mb-4">Files must be under 1MB. (Supports .png, .jpg, .svg, .gif)</p>
                    <input type="file" id="visual-upload-input" accept="image/*">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <label for="visual-upload-input" class="w-full sm:w-auto cursor-pointer px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors text-center">
                            Choose File...
                        </label>
                        <span id="visual-file-name" class="text-gray-700 sm:mt-2">No file chosen.</span>
                    </div>
                    <button type="button" id="visual-upload-btn" class="mt-3 w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50" disabled>
                        Upload Visual
                    </button>
                    <p id="visual-upload-status" class="text-blue-600 text-sm mt-3 hidden"></p>
                </div>

                <div class="mt-6 flex justify-end">
                    <button type="button" id="upload-visual-close-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button>
                </div>
            </div>
        </div>
        <!-- **** END: v4.75 Modal **** -->

        <!-- **** NEW: v4.76 - Reusable Audio Upload Modal **** -->
        <div id="upload-audio-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-2xl font-medium mb-6">Upload New Audio</h3>

                <div>
                    <p class="text-sm text-gray-600 mb-4">Files must be under 1MB. (Supports .mp3, .wav, .m4a, .ogg)</p>
                    <!-- This input uses the *existing* ID from the audio manager -->
                    <input type="file" id="audio-upload-input" accept=".mp3,.wav,.m4a,.ogg">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <label for="audio-upload-input" class="w-full sm:w-auto cursor-pointer px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors text-center">
                            Choose File...
                        </label>
                        <!-- This span uses the *existing* ID -->
                        <span id="audio-file-name" class="text-gray-700 sm:mt-2">No file chosen.</span>
                    </div>
                    <!-- This button uses the *existing* ID -->
                    <button type="button" id="audio-upload-btn" class="mt-3 w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50" disabled>
                        Upload Audio
                    </button>
                    <!-- This status uses the *existing* ID -->
                    <p id="audio-upload-status" class="text-blue-600 text-sm mt-3 hidden"></p>
                </div>

                <div class="mt-6 flex justify-end">
                    <button type="button" id="upload-audio-close-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button>
                </div>
            </div>
        </div>
        <!-- **** END: v4.76 Modal **** -->

        <!-- **** NEW: v4.44 - Multi-Add Relative Bell Modal **** -->
        <div id="multi-add-relative-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <form id="multi-add-relative-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-medium mb-6">Add Multi-Period Relative Bell</h3>

                <!-- Bell Name and Sound -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="multi-add-relative-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="multi-add-relative-bell-name" placeholder="e.g. 3 Min Clean up" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="multi-add-relative-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <!-- V5.49: Added preview button -->
                        <div class="flex items-center gap-2">
                            <select id="multi-add-relative-bell-sound" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                            <button type="button" id="preview-multi-relative-bell-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview">
                                ‚ñ∂
                            </button>
                        </div>
                    </div>
                </div>

				<!-- NEW 5.19 Visual Cue Picker -->
				<div class="mb-4">
				    <label for="multi-relative-bell-visual" class="block text-sm font-medium text-gray-700 mb-1">Visual Cue</label>
				    <select id="multi-relative-bell-visual" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
				        <option value="">[None / Period Default]</option>
				        <option value="[UPLOAD]">Upload Image...</option>
				        <option value="[CUSTOM_TEXT]">Custom Text/Color...</option>
				        <!-- Options will be populated by JS -->
				    </select>
				</div>

				<!-- Visual Display Mode & Preview (Two Column) -->
				<div class="visual-mode-preview-grid">
				    <!-- Left Column: Visual Display Mode -->
				    <div>
				        <label class="block text-sm font-medium text-gray-700 mb-2">Visual Display</label>
				        <div class="visual-mode-stack">
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="multi-relative-visual-mode" value="none" checked class="mr-2">
				                <span class="text-sm">None</span>
				            </label>
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="multi-relative-visual-mode" value="before" class="mr-2">
				                <span class="text-sm">Before</span>
				            </label>
				            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
				                <input type="radio" name="multi-relative-visual-mode" value="after" class="mr-2">
				                <span class="text-sm">After</span>
				            </label>
				        </div>
				        <p class="text-xs text-gray-500 mt-2">
				            <strong>Before:</strong> Show while counting down<br>
				            <strong>After:</strong> Show after bell rings
				        </p>
				    </div>
				    
				    <!-- Right Column: Preview -->
				    <div>
				        <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
				        <div id="multi-relative-bell-visual-preview" class="visual-preview-full">
				            <span class="visual-preview-placeholder">Select visual</span>
				        </div>
				    </div>
				</div>

                <!-- Relative Time Config - V5.44.2: Reorganized into 2 columns with hours -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <!-- Left Column: Anchor & Direction -->
                    <div class="space-y-3">
                        <div>
                            <label for="multi-add-relative-parent-anchor" class="block text-sm font-medium text-gray-700 mb-1">Parent Anchor</label>
                            <select id="multi-add-relative-parent-anchor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="period_start">Period Start</option>
                                <option value="period_end">Period End</option>
                            </select>
                        </div>
                        <div>
                            <label for="multi-add-relative-direction" class="block text-sm font-medium text-gray-700 mb-1">Direction</label>
                            <select id="multi-add-relative-direction" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="before">Before Parent</option>
                                <option value="after">After Parent</option>
                            </select>
                        </div>
                    </div>
                    <!-- Right Column: Hours, Minutes, Seconds -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Offset Time</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label for="multi-add-relative-hours" class="block text-xs text-gray-500 mb-1">Hours</label>
                                <input type="number" id="multi-add-relative-hours" value="0" min="0" max="23" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="multi-add-relative-minutes" class="block text-xs text-gray-500 mb-1">Min</label>
                                <input type="number" id="multi-add-relative-minutes" value="3" min="0" max="59" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="multi-add-relative-seconds" class="block text-xs text-gray-500 mb-1">Sec</label>
                                <input type="number" id="multi-add-relative-seconds" value="0" min="0" max="59" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Period Checkboxes -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Periods to Add to:</label>
                    <div id="multi-add-relative-period-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <!-- Checkboxes will be dynamically injected here -->
                        <p class="text-gray-500">Loading periods...</p>
                    </div>
                </div>

                <p id="multi-add-relative-status" class="text-red-600 text-sm mt-4 hidden"></p>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="multi-add-relative-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Add Bells</button>
                </div>
            </form>
        </div>

        <!-- **** NEW: v5.00 - Custom Quick Bell Manager Modal **** -->
        <div id="custom-quick-bell-manager-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <form id="custom-quick-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-medium mb-6">Custom Quick Bells Manager</h3>
                <p class="text-gray-700 mb-4">Define up to four custom, reusable quick bells.</p>

                <div id="custom-quick-bell-list-container" class="space-y-4">
                    <!-- Custom Quick Bell Rows (to be injected by JS) -->
                    <p class="text-gray-500">Loading custom bells...</p>
                </div>

                <p id="custom-quick-bell-status" class="text-red-600 text-sm mt-4 hidden"></p>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="custom-quick-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save All Custom Bells</button>
                </div>
            </form>
        </div>

        <!-- NEW V5.29.0 / V5.42.0: Passing Period Visual Modal -->
        <div id="passing-period-visual-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <form id="passing-period-visual-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
                <h3 class="text-2xl font-medium mb-4">Passing Period Visual</h3>
                <p class="text-gray-700 mb-6">This icon displays between periods (passing time).</p>

                <!-- Visual Cue Picker -->
                <div class="mb-4">
                    <label for="passing-period-visual-select" class="block text-sm font-medium text-gray-700 mb-1">Visual Cue</label>
                    <select id="passing-period-visual-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <option value="">[Default - Walking Person]</option>
                        <option value="[UPLOAD]">Upload Image...</option>
                        <option value="[CUSTOM_TEXT]">Custom Text/Color...</option>
                        <!-- Additional options populated by JS via updateVisualDropdowns() -->
                    </select>
                </div>

                <!-- Preview (centered, single column) -->
                <div class="mb-6 flex justify-center">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2 text-center">Preview</label>
                        <div id="passing-period-visual-preview" class="visual-preview-full">
                            <span class="visual-preview-placeholder">Select visual</span>
                        </div>
                    </div>
                </div>

                <p id="passing-period-visual-status" class="text-red-600 text-sm mt-4 hidden"></p>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="passing-period-visual-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Save</button>
                </div>
            </form>
        </div>

        <!-- NEW V5.29.0: Visual Background Color Picker Modal -->
        <div id="visual-bg-color-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-2xl font-medium mb-4">Customize Background Color</h3>
                <p class="text-gray-700 mb-6">Click on the preview to see how it looks with different backgrounds.</p>

                <div class="grid grid-cols-2 gap-6 mb-6">
                    <!-- Before Preview -->
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current</label>
                        <div id="visual-bg-before-preview" class="visual-preview-full mx-auto">
                            <span class="visual-preview-placeholder">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- After Preview -->
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-700 mb-2">New</label>
                        <div id="visual-bg-after-preview" class="visual-preview-full mx-auto">
                            <span class="visual-preview-placeholder">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Color Picker -->
                <div class="mb-6">
                    <label for="visual-bg-color-input" class="block text-sm font-medium text-gray-700 mb-2">Background Color</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="visual-bg-color-input" value="#1f2937" 
                               class="w-16 h-10 rounded cursor-pointer border border-gray-300">
                        <input type="text" id="visual-bg-color-hex" value="#1f2937" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"
                               placeholder="#1f2937">
                        <button type="button" id="visual-bg-reset-btn" 
                                class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                            Reset
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Default: #1f2937 (dark gray)</p>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" id="visual-bg-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="button" id="visual-bg-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply</button>
                </div>
            </div>
        </div>


        <!-- V5.49: Hidden in kiosk mode -->
        <div id="audio-manager-panel" class="auth-required mt-12 max-w-4xl mx-auto kiosk-hide">
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
                <!-- V5.44.8: Standardized header format -->
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 cursor-pointer" title="Click to refresh file lists">My Audio Manager</h3>

                <div>
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Upload New Audio File</h4>
                    <button type="button" id="show-audio-upload-modal-btn" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        Upload New Audio...
                    </button>
                </div>

                <!-- My Audio Files List -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">My Audio Files</h4>
                    <div id="my-audio-files-list" class="space-y-2">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>

                <!-- Shared Audio Files List -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Shared Audio Files</h4>
                    <div id="shared-audio-files-list" class="space-y-2">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- **** NEW: v4.44 - Visual Manager Panel **** -->
        <!-- V5.49: Hidden in kiosk mode -->
        <div id="visual-manager-panel" class="auth-required mt-12 max-w-4xl mx-auto kiosk-hide">
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
                <!-- V5.44.8: Standardized header format -->
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 cursor-pointer" title="Click to refresh file lists">My Visual Manager</h3>

                <div>
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Upload New Visual File</h4>
                    <button type="button" id="show-visual-upload-modal-btn" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        Upload New Visual...
                    </button>
                </div>

                <!-- My Visual Files List -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">My Visuals</h4>
                    <div id="my-visual-files-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <p class="text-gray-500 col-span-full">Loading...</p>
                    </div>
                </div>

                <!-- Shared Visual Files List -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Shared Visuals</h4>
                    <div id="shared-visual-files-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <p class="text-gray-500 col-span-full">Loading...</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- NEW: Footer for User ID and Credit -->
        <footer class="text-center p-4 mt-8 text-gray-500 text-sm border-t border-gray-200">
            <p class="mb-2">Web app started with and broken by Google Gemini.  Fixed with Claude.</p>
            <p>
                <code id="userIdDisplay" class="bg-gray-200 px-2 py-1 rounded">...</code>
            </p>
			<div class="text-center mt-2 text-xs text-gray-400">
   		 		App Version: <span id="app-version-display" class="font-bold text-gray-600">Loading...</span>
   		 		&nbsp;|&nbsp;
   		 		CSS Version: <span id="css-version-display" class="font-bold text-gray-600">Loading...</span>
			</div>
        </footer>

        <input type="file" id="restore-file-input" class="hidden" accept="application/json,.json">

    </div>

       	<!-- 5.06 Moving JS out -->
		<script type="module" src="script.js"></script>
</body>
</html>

<!--
HOW TO ADD A NEW ADMIN:

1.  Ask the new admin to visit this web app and sign in with their Google account.
2.  Have them find their "User ID" in the footer of this page (it looks like a long string of letters and numbers).
3.  Have them send you their User ID.
4.  Go to your Firebase Console: https://console.firebase.google.com/
5.  Select your project: 'ellisbell-c185c'
6.  Navigate to the Firestore Database: (Build -> Firestore Database)
7.  Follow this path in the data viewer:
    artifacts -> 1:441560045695:web:94e51a006663404b8f474a -> public -> data -> admins
    (If the 'admins' collection doesn't exist under 'data', you will need to create it by clicking "+ Start collection" and naming it 'admins').
8.  Click "+ Add document".
9.  In the "Document ID" field, paste the new admin's User ID.
10. In the "Fields" section, add a field:
    * Field: email
    * Type: string
    * Value: (The new admin's email address)
11. Click "Save".

The new admin will have admin privileges (including the "Make Public" button) the next time they refresh the app.
-->

<!-- Version 5.39.0 -->
