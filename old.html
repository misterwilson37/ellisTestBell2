<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ellis Bell - Legacy (iOS 9)</title>
    
    <!-- Add to Home Screen - iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ellis Bell">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231f2937' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle'>üîî</text></svg>">
    
    <!-- Add to Home Screen - Android/Chrome -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1f2937">
    
    <!-- Prevent phone number detection -->
    <meta name="format-detection" content="telephone=no">
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Century Gothic', 'Avant Garde', Arial, Helvetica, sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            color: #1f2937;
            padding: 3vmin;
            -webkit-transition: background-color 0.3s, color 0.3s;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Dark mode styles */
        body.dark-mode {
            background-color: #111827;
            color: #f3f4f6;
        }
        body.dark-mode .card {
            background: #1f2937;
            color: #f3f4f6;
        }
        body.dark-mode .card label {
            color: #9ca3af;
        }
        body.dark-mode input[type="text"] {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }
        body.dark-mode input[type="text"]:focus {
            border-color: #60a5fa;
        }
        body.dark-mode .btn-secondary {
            background: #374151;
            color: #e5e7eb;
        }
        body.dark-mode .btn-secondary:hover {
            background: #4b5563;
        }
        body.dark-mode .header-title {
            color: #93c5fd;
        }
        body.dark-mode .bell-item {
            border-bottom-color: #374151;
        }
        body.dark-mode .bell-name {
            color: #e5e7eb;
        }
        body.dark-mode .bell-next {
            background: #1e3a5f;
        }
        body.dark-mode .bell-next .bell-time {
            color: #93c5fd;
        }
        body.dark-mode .bell-next .bell-name {
            color: #bfdbfe;
        }
        
        .container {
            max-width: 95vw;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 6vmin;
            margin-bottom: 3vmin;
            color: #1e3a5f;
            font-weight: bold;
        }
        .card {
            background: #fff;
            border-radius: 2vmin;
            padding: 4vmin;
            margin-bottom: 3vmin;
            -webkit-box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            -webkit-transition: background-color 0.3s, color 0.3s;
            transition: background-color 0.3s, color 0.3s;
        }
        .clock-card {
            background: #1f2937;
            color: #fff;
            border-radius: 3vmin;
            padding: 5vmin;
            margin-bottom: 3vmin;
            -webkit-box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .clock {
            font-size: 15vmin;
            font-weight: bold;
            text-align: center;
            font-family: 'Century Gothic', 'Avant Garde', Arial, Helvetica, sans-serif;
            color: #fff;
            margin: 2vmin 0;
            letter-spacing: 0.3vmin;
            line-height: 1.1;
            white-space: nowrap;
        }
        .countdown {
            font-size: 12vmin;
            font-weight: bold;
            text-align: center;
            font-family: 'Century Gothic', 'Avant Garde', Arial, Helvetica, sans-serif;
            color: #4ade80;
            margin: 2vmin 0;
            line-height: 1.1;
        }
        .next-bell {
            text-align: center;
            font-size: 5vmin;
            color: #9ca3af;
            margin: 2vmin 0;
        }
        .schedule-name {
            text-align: center;
            font-size: 3vmin;
            color: #6b7280;
            margin-bottom: 2vmin;
            text-transform: uppercase;
            letter-spacing: 0.3vmin;
        }
        label {
            display: block;
            font-size: 3.5vmin;
            color: #6b7280;
            margin-bottom: 2vmin;
            font-weight: 500;
        }
        input[type="text"] {
            width: 100%;
            padding: 4vmin;
            font-size: 5vmin;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1vmin;
            border: 2px solid #e5e7eb;
            border-radius: 2vmin;
            background: #fff;
            color: #1f2937;
            outline: none;
            font-family: 'Century Gothic', 'Avant Garde', Arial, Helvetica, sans-serif;
            -webkit-appearance: none;
            appearance: none;
            -webkit-transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        input[type="text"]:focus {
            border-color: #3b82f6;
            -webkit-box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        button {
            width: 100%;
            padding: 4vmin;
            font-size: 4vmin;
            font-weight: bold;
            border: none;
            border-radius: 2vmin;
            cursor: pointer;
            margin-top: 3vmin;
            font-family: 'Century Gothic', 'Avant Garde', Arial, Helvetica, sans-serif;
            -webkit-appearance: none;
            appearance: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            /* Larger touch targets */
            min-height: 12vmin;
        }
        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }
        .btn-primary:hover,
        .btn-primary:active {
            background: #2563eb;
        }
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
            -webkit-transition: background-color 0.3s, color 0.3s;
            transition: background-color 0.3s, color 0.3s;
        }
        .btn-secondary:hover,
        .btn-secondary:active {
            background: #d1d5db;
        }
        .btn-enable {
            background: #22c55e;
            color: #fff;
            font-size: 5vmin;
            padding: 5vmin;
            min-height: 15vmin;
        }
        .btn-enable:hover,
        .btn-enable:active {
            background: #16a34a;
        }
        .status {
            text-align: center;
            font-size: 3.5vmin;
            color: #f59e0b;
            margin-top: 2vmin;
        }
        .error {
            color: #ef4444;
        }
        .success {
            color: #22c55e;
        }
        .hidden {
            display: none;
        }
        .bell-list {
            max-height: 40vmin;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 3vmin;
        }
        .bell-item {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            padding: 2.5vmin 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 3.5vmin;
            -webkit-transition: border-color 0.3s;
            transition: border-color 0.3s;
        }
        .bell-item:last-child {
            border-bottom: none;
        }
        .bell-time {
            color: #3b82f6;
            font-family: 'Century Gothic', 'Avant Garde', Arial, Helvetica, sans-serif;
            font-weight: 600;
        }
        .bell-name {
            color: #374151;
            -webkit-transition: color 0.3s;
            transition: color 0.3s;
        }
        .bell-passed {
            opacity: 0.4;
            text-decoration: line-through;
        }
        .bell-next {
            background: #dbeafe;
            margin: 0 -4vmin;
            padding: 2.5vmin 4vmin;
            border-radius: 0;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
        }
        .bell-next .bell-time {
            color: #1d4ed8;
        }
        .bell-next .bell-name {
            color: #1e40af;
            font-weight: 600;
        }
        .version {
            text-align: center;
            font-size: 2.5vmin;
            color: #9ca3af;
            margin-top: 3vmin;
        }
        /* iOS 9 flexbox fixes - NO gap property, use margins instead */
        .flex-row {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: horizontal;
            -webkit-flex-direction: row;
            flex-direction: row;
        }
        .button-row {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: horizontal;
            -webkit-flex-direction: row;
            flex-direction: row;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
        }
        .button-row button {
            -webkit-box-flex: 1;
            -webkit-flex: 1 1 auto;
            flex: 1 1 auto;
            margin: 1vmin;
            min-width: 40%;
        }
        .button-row-3 button {
            -webkit-flex: 1 1 30%;
            flex: 1 1 30%;
            min-width: 30%;
        }
        .btn-refresh {
            background: #0ea5e9;
            color: #fff;
        }
        .btn-refresh:hover,
        .btn-refresh:active {
            background: #0284c7;
        }
        .btn-dark-toggle {
            background: #6366f1;
            color: #fff;
        }
        .btn-dark-toggle:hover,
        .btn-dark-toggle:active {
            background: #4f46e5;
        }
        .btn-fullscreen {
            background: #8b5cf6;
            color: #fff;
        }
        .btn-fullscreen:hover,
        .btn-fullscreen:active {
            background: #7c3aed;
        }
        .last-refresh {
            text-align: center;
            font-size: 2.5vmin;
            color: #9ca3af;
            margin-top: 2vmin;
        }
        /* Header styling - horizontal layout with icon on left */
        .header {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: horizontal;
            -webkit-flex-direction: row;
            flex-direction: row;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            margin-bottom: 3vmin;
        }
        .header-icon {
            font-size: 12vmin;
            margin-right: 3vmin;
            line-height: 1;
        }
        .header-text {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-flex-direction: column;
            flex-direction: column;
        }
        .header-title {
            font-size: 8vmin;
            color: #1e3a5f;
            font-weight: bold;
            margin: 0;
            line-height: 1.1;
            -webkit-transition: color 0.3s;
            transition: color 0.3s;
        }
        .header-subtitle {
            font-size: 3vmin;
            color: #9ca3af;
            margin-top: 0.5vmin;
        }
        
        /* Kiosk mode - hide non-essential UI */
        body.kiosk-mode .bell-list-card,
        body.kiosk-mode .button-row,
        body.kiosk-mode .last-refresh,
        body.kiosk-mode .version {
            display: none;
        }
        body.kiosk-mode .clock-card {
            margin-bottom: 0;
        }
        body.kiosk-mode .clock {
            font-size: 18vmin;
        }
        body.kiosk-mode .countdown {
            font-size: 15vmin;
        }
        body.kiosk-mode .next-bell {
            font-size: 6vmin;
        }
        /* Kiosk exit hint */
        .kiosk-exit-hint {
            text-align: center;
            font-size: 2.5vmin;
            color: #6b7280;
            margin-top: 3vmin;
            display: none;
        }
        body.kiosk-mode .kiosk-exit-hint {
            display: block;
        }
        .kiosk-exit-link {
            color: #9ca3af;
            text-decoration: underline;
            cursor: pointer;
        }
        .kiosk-exit-link:hover {
            color: #d1d5db;
        }
        
        /* Tap zone to exit kiosk mode */
        .kiosk-exit-zone {
            position: fixed;
            top: 0;
            right: 0;
            width: 15vmin;
            height: 15vmin;
            z-index: 1000;
            /* Invisible but tappable */
        }
        .kiosk-exit-zone.hidden {
            display: none;
        }
        
        /* Home screen hint */
        .homescreen-hint {
            text-align: center;
            font-size: 2.5vmin;
            color: #9ca3af;
            margin-top: 2vmin;
            padding: 2vmin;
            background: rgba(0,0,0,0.05);
            border-radius: 1vmin;
        }
        body.dark-mode .homescreen-hint {
            background: rgba(255,255,255,0.05);
        }
        .homescreen-hint.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">üîî</div>
            <div class="header-text">
                <h1 class="header-title">Ellis Bell</h1>
                <p class="header-subtitle">Legacy Mode</p>
            </div>
        </div>
        
        <!-- Code Entry Screen -->
        <div id="code-screen" class="card">
            <label for="share-code">Enter Share Code:</label>
            <input type="text" id="share-code" maxlength="6" placeholder="ABC123" autocomplete="off" autocorrect="off" autocapitalize="characters">
            <button type="button" id="load-btn" class="btn-primary">Load Schedule</button>
            <div id="code-status" class="status hidden"></div>
            <div id="homescreen-hint" class="homescreen-hint hidden">
                üí° Tip: Add this page to your home screen for a full-screen clock experience!
            </div>
        </div>
        
        <!-- Audio Enable Screen (iOS requires user gesture) -->
        <div id="audio-screen" class="card hidden">
            <p style="text-align: center; margin-bottom: 15px; color: #6b7280;">
                iOS requires you to tap below to enable bell sounds.
            </p>
            <button type="button" id="enable-audio-btn" class="btn-enable">üîä Enable Bell Sounds</button>
        </div>
        
        <!-- Main Clock Screen -->
        <div id="clock-screen" class="hidden">
            <div class="clock-card">
                <div class="schedule-name" id="schedule-name">Loading...</div>
                <div class="clock" id="current-time">--:--:--</div>
                <div class="countdown" id="countdown">--:--</div>
                <div class="next-bell" id="next-bell">Loading schedule...</div>
                
                <!-- Kiosk exit hint - only visible in kiosk mode -->
                <div class="kiosk-exit-hint">
                    <span class="kiosk-exit-link" id="kiosk-exit-link">Triple-tap here or top-right corner to exit kiosk mode</span>
                </div>
            </div>
            
            <div class="card bell-list-card">
                <label>Today's Bells:</label>
                <div class="bell-list" id="bell-list"></div>
            </div>
            
            <div class="button-row button-row-3">
                <button type="button" id="refresh-schedule-btn" class="btn-refresh">üîÑ Refresh</button>
                <button type="button" id="dark-mode-btn" class="btn-dark-toggle">üåô Dark</button>
                <button type="button" id="fullscreen-btn" class="btn-fullscreen">‚õ∂ Full</button>
            </div>
            <div class="button-row">
                <button type="button" id="kiosk-btn" class="btn-secondary">üñ•Ô∏è Kiosk Mode</button>
                <button type="button" id="change-schedule-btn" class="btn-secondary">Change Schedule</button>
            </div>
            <div id="last-refresh" class="last-refresh"></div>
        </div>
        
        <div class="version">Ellis Bell Legacy v1.4.1 (iOS 9+)</div>
    </div>
    
    <!-- Invisible tap zone to exit kiosk mode (top-right corner) -->
    <div id="kiosk-exit-zone" class="kiosk-exit-zone hidden"></div>
    
    <!-- Hidden audio element for bell sounds -->
    <audio id="bell-audio" preload="auto"></audio>
    
    <script>
    (function() {
        'use strict';
        
        // ===========================================
        // === POLYFILLS FOR LEGACY BROWSERS ===
        // ===========================================
        
        // Console safety (some old WebViews lack console)
        if (typeof console === 'undefined' || typeof console.log === 'undefined') {
            window.console = {
                log: function() {},
                warn: function() {},
                error: function() {}
            };
        }
        
        // String.trim polyfill
        if (!String.prototype.trim) {
            String.prototype.trim = function() {
                return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
            };
        }
        
        // Object.keys polyfill
        if (!Object.keys) {
            Object.keys = function(obj) {
                var keys = [];
                for (var key in obj) {
                    if (Object.prototype.hasOwnProperty.call(obj, key)) {
                        keys.push(key);
                    }
                }
                return keys;
            };
        }
        
        // Array.isArray polyfill
        if (!Array.isArray) {
            Array.isArray = function(arg) {
                return Object.prototype.toString.call(arg) === '[object Array]';
            };
        }
        
        // classList polyfill for old browsers
        if (!('classList' in document.documentElement)) {
            Object.defineProperty(HTMLElement.prototype, 'classList', {
                get: function() {
                    var self = this;
                    function update(fn) {
                        return function(value) {
                            var classes = self.className.split(/\s+/);
                            var index = classes.indexOf(value);
                            fn(classes, index, value);
                            self.className = classes.join(' ');
                        };
                    }
                    return {
                        add: update(function(classes, index, value) {
                            if (index === -1) classes.push(value);
                        }),
                        remove: update(function(classes, index) {
                            if (index !== -1) classes.splice(index, 1);
                        }),
                        toggle: update(function(classes, index, value) {
                            if (index === -1) classes.push(value);
                            else classes.splice(index, 1);
                        }),
                        contains: function(value) {
                            return self.className.split(/\s+/).indexOf(value) !== -1;
                        }
                    };
                }
            });
        }
        
        // Array.indexOf polyfill (needed for classList polyfill)
        if (!Array.prototype.indexOf) {
            Array.prototype.indexOf = function(searchElement, fromIndex) {
                var k;
                if (this == null) throw new TypeError('"this" is null or not defined');
                var o = Object(this);
                var len = o.length >>> 0;
                if (len === 0) return -1;
                var n = fromIndex | 0;
                if (n >= len) return -1;
                k = Math.max(n >= 0 ? n : len - Math.abs(n), 0);
                while (k < len) {
                    if (k in o && o[k] === searchElement) return k;
                    k++;
                }
                return -1;
            };
        }
        
        // Date.now polyfill
        if (!Date.now) {
            Date.now = function() {
                return new Date().getTime();
            };
        }
        
        // JSON polyfill check (should exist but just in case)
        if (typeof JSON === 'undefined') {
            console.error('JSON not supported - this browser is too old');
            alert('This browser does not support JSON. Please use a newer browser.');
            return;
        }
        
        // ===========================================
        // === CONFIGURATION ===
        // ===========================================
        
        var PROJECT_ID = 'ellisbell-c185c';
        var APP_ID = '1:441560045695:web:94e51a006663404b8f474a';
        var FIRESTORE_BASE = 'https://firestore.googleapis.com/v1/projects/' + PROJECT_ID + '/databases/(default)/documents';
        var DEFAULT_SOUND = 'https://firebasestorage.googleapis.com/v0/b/ellisbell-c185c.appspot.com/o/sounds%2Fpublic%2FellisBell.mp3?alt=media';
        
        // ===========================================
        // === STATE ===
        // ===========================================
        
        var bells = [];
        var scheduleName = '';
        var audioEnabled = false;
        var lastRungBellTime = null;
        var clockInterval = null;
        var wakeLock = null;
        var kioskTapCount = 0;
        var kioskTapTimer = null;
        
        // ===========================================
        // === DOM ELEMENTS ===
        // ===========================================
        
        var codeScreen = document.getElementById('code-screen');
        var audioScreen = document.getElementById('audio-screen');
        var clockScreen = document.getElementById('clock-screen');
        var shareCodeInput = document.getElementById('share-code');
        var loadBtn = document.getElementById('load-btn');
        var codeStatus = document.getElementById('code-status');
        var enableAudioBtn = document.getElementById('enable-audio-btn');
        var scheduleNameEl = document.getElementById('schedule-name');
        var currentTimeEl = document.getElementById('current-time');
        var countdownEl = document.getElementById('countdown');
        var nextBellEl = document.getElementById('next-bell');
        var bellListEl = document.getElementById('bell-list');
        var changeScheduleBtn = document.getElementById('change-schedule-btn');
        var refreshScheduleBtn = document.getElementById('refresh-schedule-btn');
        var lastRefreshEl = document.getElementById('last-refresh');
        var bellAudio = document.getElementById('bell-audio');
        var darkModeBtn = document.getElementById('dark-mode-btn');
        var fullscreenBtn = document.getElementById('fullscreen-btn');
        var kioskBtn = document.getElementById('kiosk-btn');
        var kioskExitZone = document.getElementById('kiosk-exit-zone');
        var kioskExitLink = document.getElementById('kiosk-exit-link');
        var homescreenHint = document.getElementById('homescreen-hint');
        
        // ===========================================
        // === UTILITIES ===
        // ===========================================
        
        // Array.find polyfill for iOS 9
        function arrayFind(arr, predicate) {
            for (var i = 0; i < arr.length; i++) {
                if (predicate(arr[i], i, arr)) {
                    return arr[i];
                }
            }
            return undefined;
        }
        
        // Parse Firestore REST API field value
        function parseFieldValue(field) {
            if (!field) return null;
            if (field.stringValue !== undefined) return field.stringValue;
            if (field.integerValue !== undefined) return parseInt(field.integerValue, 10);
            if (field.booleanValue !== undefined) return field.booleanValue;
            if (field.arrayValue !== undefined) {
                var arr = [];
                var values = field.arrayValue.values || [];
                for (var i = 0; i < values.length; i++) {
                    arr.push(parseFieldValue(values[i]));
                }
                return arr;
            }
            if (field.mapValue !== undefined) {
                return parseFields(field.mapValue.fields || {});
            }
            return null;
        }
        
        // Parse Firestore fields object
        function parseFields(fields) {
            var result = {};
            for (var key in fields) {
                if (Object.prototype.hasOwnProperty.call(fields, key)) {
                    result[key] = parseFieldValue(fields[key]);
                }
            }
            return result;
        }
        
        // Format time to 12-hour with AM/PM (compact version to prevent wrapping)
        function formatTime12Hour(timeStr) {
            if (!timeStr) return '--:--';
            var parts = timeStr.split(':');
            var hours = parseInt(parts[0], 10);
            var minutes = parts[1];
            var ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            if (hours === 0) hours = 12;
            // No space before AM/PM to save horizontal space
            return hours + ':' + minutes + ampm;
        }
        
        // Format countdown
        function formatCountdown(seconds) {
            if (seconds < 0) return '--:--';
            var h = Math.floor(seconds / 3600);
            var m = Math.floor((seconds % 3600) / 60);
            var s = seconds % 60;
            if (h > 0) {
                return h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
            }
            return m + ':' + (s < 10 ? '0' : '') + s;
        }
        
        // Get current time as HH:MM:SS
        function getCurrentTimeHHMMSS() {
            var now = new Date();
            var h = now.getHours();
            var m = now.getMinutes();
            var s = now.getSeconds();
            return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
        }
        
        // Convert HH:MM:SS to seconds since midnight
        function timeToSeconds(timeStr) {
            var parts = timeStr.split(':');
            return parseInt(parts[0], 10) * 3600 + parseInt(parts[1], 10) * 60 + parseInt(parts[2] || 0, 10);
        }
        
        // Show status message
        function showStatus(message, type) {
            codeStatus.textContent = message;
            codeStatus.className = 'status ' + (type || '');
            removeClass(codeStatus, 'hidden');
        }
        
        // Safe time formatting with fallback for older Safari
        function formatTimeForDisplay(date) {
            try {
                var result = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                if (result && result.length < 15) {
                    return result;
                }
            } catch (e) {
                // Fall through to manual formatting
            }
            var h = date.getHours();
            var m = date.getMinutes();
            var ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            if (h === 0) h = 12;
            return h + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
        }
        
        // Safe class manipulation (works even if classList polyfill fails)
        function addClass(el, className) {
            if (el.classList) {
                el.classList.add(className);
            } else {
                if ((' ' + el.className + ' ').indexOf(' ' + className + ' ') === -1) {
                    el.className = el.className ? el.className + ' ' + className : className;
                }
            }
        }
        
        function removeClass(el, className) {
            if (el.classList) {
                el.classList.remove(className);
            } else {
                el.className = el.className.replace(new RegExp('(^|\\s)' + className + '(\\s|$)', 'g'), ' ').trim();
            }
        }
        
        function hasClass(el, className) {
            if (el.classList) {
                return el.classList.contains(className);
            }
            return (' ' + el.className + ' ').indexOf(' ' + className + ' ') !== -1;
        }
        
        function toggleClass(el, className) {
            if (hasClass(el, className)) {
                removeClass(el, className);
            } else {
                addClass(el, className);
            }
        }
        
        // ===========================================
        // === API CALLS ===
        // ===========================================
        
        function fetchDocument(path, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', FIRESTORE_BASE + path, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            callback(null, data);
                        } catch (e) {
                            callback(new Error('Failed to parse response'));
                        }
                    } else if (xhr.status === 404) {
                        callback(new Error('Not found'));
                    } else {
                        callback(new Error('Request failed: ' + xhr.status));
                    }
                }
            };
            xhr.onerror = function() {
                callback(new Error('Network error'));
            };
            xhr.send();
        }
        
        // ===========================================
        // === SCHEDULE LOADING ===
        // ===========================================
        
        function loadScheduleFromCode(code) {
            code = code.toUpperCase().trim();
            
            if (code.length !== 6) {
                showStatus('Code must be 6 characters', 'error');
                return;
            }
            
            showStatus('Looking up code...', '');
            loadBtn.disabled = true;
            
            var shareCodePath = '/artifacts/' + APP_ID + '/public/data/share_codes/' + code;
            
            fetchDocument(shareCodePath, function(err, shareCodeDoc) {
                if (err) {
                    showStatus('Share code not found', 'error');
                    loadBtn.disabled = false;
                    return;
                }
                
                var shareData = parseFields(shareCodeDoc.fields || {});
                var ownerId = shareData.ownerId;
                var scheduleId = shareData.scheduleId;
                scheduleName = shareData.scheduleName || 'Schedule';
                
                if (!ownerId || !scheduleId) {
                    showStatus('Invalid share code data', 'error');
                    loadBtn.disabled = false;
                    return;
                }
                
                showStatus('Loading schedule...', '');
                
                var schedulePath = '/artifacts/' + APP_ID + '/users/' + ownerId + '/personal_schedules/' + scheduleId;
                
                fetchDocument(schedulePath, function(err2, scheduleDoc) {
                    if (err2) {
                        loadBtn.disabled = false;
                        showStatus('Schedule not found (may have been deleted)', 'error');
                        return;
                    }
                    
                    var scheduleData = parseFields(scheduleDoc.fields || {});
                    console.log('Personal schedule data:', scheduleData);
                    
                    var isStandalone = !scheduleData.baseScheduleId || scheduleData.isStandalone;
                    console.log('Is standalone:', isStandalone, 'baseScheduleId:', scheduleData.baseScheduleId);
                    
                    if (isStandalone) {
                        bells = extractBellsFromSchedule(scheduleData);
                        finishLoading(code);
                    } else {
                        showStatus('Loading base schedule...', '');
                        var basePath = '/artifacts/' + APP_ID + '/public/data/schedules/' + scheduleData.baseScheduleId;
                        
                        fetchDocument(basePath, function(err3, baseDoc) {
                            if (err3) {
                                console.warn('Could not load base schedule, using personal only');
                                bells = extractBellsFromSchedule(scheduleData);
                            } else {
                                var baseData = parseFields(baseDoc.fields || {});
                                console.log('Base schedule data:', baseData);
                                
                                var basePeriods = baseData.periods || [];
                                var personalPeriods = scheduleData.periods || [];
                                var mergedPeriods = [];
                                var periodMap = {};
                                
                                for (var bp = 0; bp < basePeriods.length; bp++) {
                                    var period = basePeriods[bp];
                                    if (period && period.name) {
                                        periodMap[period.name] = {
                                            name: period.name,
                                            bells: period.bells ? period.bells.slice() : []
                                        };
                                    }
                                }
                                
                                for (var pp = 0; pp < personalPeriods.length; pp++) {
                                    var pPeriod = personalPeriods[pp];
                                    if (pPeriod && pPeriod.name) {
                                        if (periodMap[pPeriod.name]) {
                                            var existingBells = periodMap[pPeriod.name].bells;
                                            var newBells = pPeriod.bells || [];
                                            for (var nb = 0; nb < newBells.length; nb++) {
                                                existingBells.push(newBells[nb]);
                                            }
                                        } else {
                                            periodMap[pPeriod.name] = {
                                                name: pPeriod.name,
                                                bells: pPeriod.bells ? pPeriod.bells.slice() : []
                                            };
                                        }
                                    }
                                }
                                
                                for (var pName in periodMap) {
                                    if (Object.prototype.hasOwnProperty.call(periodMap, pName)) {
                                        mergedPeriods.push(periodMap[pName]);
                                    }
                                }
                                
                                console.log('Merged periods:', mergedPeriods);
                                bells = extractBellsFromSchedule({ periods: mergedPeriods });
                            }
                            finishLoading(code);
                        });
                    }
                });
                
                function finishLoading(code) {
                    loadBtn.disabled = false;
                    
                    console.log('Extracted bells:', bells);
                    
                    if (bells.length === 0) {
                        showStatus('No bells found in schedule (check console for debug info)', 'error');
                        return;
                    }
                    
                    bells.sort(function(a, b) {
                        return a.time.localeCompare(b.time);
                    });
                    
                    var uniqueBells = [];
                    var seenTimes = {};
                    for (var i = 0; i < bells.length; i++) {
                        if (!seenTimes[bells[i].time]) {
                            seenTimes[bells[i].time] = true;
                            uniqueBells.push(bells[i]);
                        }
                    }
                    bells = uniqueBells;
                    
                    try {
                        localStorage.setItem('ellisBellLegacy_code', code);
                        localStorage.setItem('ellisBellLegacy_bells', JSON.stringify(bells));
                        localStorage.setItem('ellisBellLegacy_name', scheduleName);
                        localStorage.setItem('ellisBellLegacy_timestamp', Date.now().toString());
                    } catch (e) {
                        // localStorage might not be available
                    }
                    
                    showStatus('Loaded ' + bells.length + ' bells!', 'success');
                    
                    setTimeout(function() {
                        addClass(codeScreen, 'hidden');
                        removeClass(audioScreen, 'hidden');
                    }, 500);
                }
            });
        }
        
        function secondsToTimeStr(totalSeconds) {
            while (totalSeconds < 0) totalSeconds += 86400;
            totalSeconds = totalSeconds % 86400;
            
            var h = Math.floor(totalSeconds / 3600);
            var m = Math.floor((totalSeconds % 3600) / 60);
            var s = totalSeconds % 60;
            return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
        }
        
        function extractBellsFromSchedule(scheduleData) {
            var extractedBells = [];
            var periods = scheduleData.periods || [];
            
            console.log('extractBellsFromSchedule - periods:', periods);
            console.log('extractBellsFromSchedule - periods length:', periods.length);
            
            var bellMap = {};
            var allBells = [];
            
            for (var i = 0; i < periods.length; i++) {
                var period = periods[i];
                if (!period || !period.bells) continue;
                
                for (var j = 0; j < period.bells.length; j++) {
                    var bell = period.bells[j];
                    if (!bell) continue;
                    
                    bell._periodName = period.name;
                    bell._periodBells = period.bells;
                    allBells.push(bell);
                    
                    if (bell.time && !bell.relative && bell.bellId) {
                        bellMap[bell.bellId] = bell;
                    }
                }
            }
            
            console.log('Static bells in map:', Object.keys(bellMap).length);
            console.log('Total bells to process:', allBells.length);
            
            function calculateBellTime(bell, visited) {
                if (!visited) visited = {};
                
                if (bell.time && !bell.relative) {
                    return bell.time;
                }
                
                if (!bell.relative) {
                    console.log('Bell has no time and no relative data:', bell.name);
                    return null;
                }
                
                if (bell.bellId && visited[bell.bellId]) {
                    console.warn('Circular reference detected for bell:', bell.name);
                    return null;
                }
                if (bell.bellId) visited[bell.bellId] = true;
                
                var parentTime = null;
                
                if (bell.relative.parentBellId) {
                    var parentBell = bellMap[bell.relative.parentBellId];
                    if (!parentBell) {
                        for (var k = 0; k < allBells.length; k++) {
                            if (allBells[k].bellId === bell.relative.parentBellId) {
                                parentBell = allBells[k];
                                break;
                            }
                        }
                    }
                    
                    if (parentBell) {
                        parentTime = calculateBellTime(parentBell, visited);
                    } else {
                        console.warn('Parent bell not found:', bell.relative.parentBellId);
                    }
                }
                else if (bell.relative.parentPeriodName) {
                    var parentPeriodName = bell.relative.parentPeriodName;
                    var anchorType = bell.relative.parentAnchorType;
                    
                    var parentPeriod = null;
                    for (var p = 0; p < periods.length; p++) {
                        if (periods[p].name === parentPeriodName) {
                            parentPeriod = periods[p];
                            break;
                        }
                    }
                    
                    if (parentPeriod && parentPeriod.bells && parentPeriod.bells.length > 0) {
                        var staticBells = [];
                        for (var sb = 0; sb < parentPeriod.bells.length; sb++) {
                            var b = parentPeriod.bells[sb];
                            if (b.time && !b.relative) {
                                staticBells.push(b);
                            }
                        }
                        
                        staticBells.sort(function(a, b) {
                            return a.time.localeCompare(b.time);
                        });
                        
                        var anchorBell = null;
                        if (anchorType === 'period_start' && staticBells.length > 0) {
                            anchorBell = staticBells[0];
                        } else if (anchorType === 'period_end' && staticBells.length > 0) {
                            anchorBell = staticBells[staticBells.length - 1];
                        }
                        
                        if (!anchorBell) {
                            for (var ar = 0; ar < parentPeriod.bells.length; ar++) {
                                var arBell = parentPeriod.bells[ar];
                                if (anchorType === 'period_start' && arBell.anchorRole === 'start') {
                                    anchorBell = arBell;
                                    break;
                                }
                                if (anchorType === 'period_end' && arBell.anchorRole === 'end') {
                                    anchorBell = arBell;
                                    break;
                                }
                            }
                        }
                        
                        if (anchorBell) {
                            parentTime = calculateBellTime(anchorBell, visited);
                        } else {
                            console.warn('No anchor bell found in period:', parentPeriodName);
                        }
                    } else {
                        console.warn('Parent period not found or empty:', parentPeriodName);
                    }
                }
                
                if (parentTime) {
                    var parentSeconds = timeToSeconds(parentTime);
                    var offsetSeconds = bell.relative.offsetSeconds || 0;
                    var finalSeconds = parentSeconds + offsetSeconds;
                    return secondsToTimeStr(finalSeconds);
                }
                
                return null;
            }
            
            for (var b = 0; b < allBells.length; b++) {
                var bell = allBells[b];
                var time = calculateBellTime(bell, {});
                
                if (time) {
                    if (time.split(':').length === 2) {
                        time = time + ':00';
                    }
                    
                    extractedBells.push({
                        time: time,
                        name: bell.name || 'Bell',
                        sound: bell.sound || DEFAULT_SOUND,
                        periodName: bell._periodName || ''
                    });
                    
                    console.log('Added bell:', bell.name, 'at', time, bell.relative ? '(relative)' : '(static)');
                } else {
                    console.log('Could not calculate time for bell:', bell.name);
                }
            }
            
            console.log('extractBellsFromSchedule - total extracted:', extractedBells.length);
            return extractedBells;
        }
        
        // ===========================================
        // === AUDIO ===
        // ===========================================
        
        function enableAudio() {
            bellAudio.src = DEFAULT_SOUND;
            bellAudio.volume = 0.01;
            
            var playPromise;
            try {
                playPromise = bellAudio.play();
            } catch (e) {
                playPromise = undefined;
            }
            
            if (playPromise !== undefined && typeof playPromise.then === 'function') {
                playPromise.then(function() {
                    bellAudio.pause();
                    bellAudio.currentTime = 0;
                    bellAudio.volume = 1.0;
                    audioEnabled = true;
                    startClock();
                }).catch(function(e) {
                    console.warn('Audio promise rejected:', e);
                    audioEnabled = true;
                    startClock();
                });
            } else {
                setTimeout(function() {
                    try {
                        bellAudio.pause();
                        bellAudio.currentTime = 0;
                        bellAudio.volume = 1.0;
                    } catch (e) {
                        console.warn('Audio setup error:', e);
                    }
                    audioEnabled = true;
                    startClock();
                }, 100);
            }
        }
        
        function playBellSound(soundUrl) {
            if (!audioEnabled) return;
            
            var url = soundUrl || DEFAULT_SOUND;
            
            if (!url || url === 'ellisBell.mp3' || url === '[SILENT]' || url.indexOf('http') !== 0) {
                if (url === '[SILENT]') {
                    console.log('Silent bell - not playing');
                    return;
                }
                url = DEFAULT_SOUND;
            }
            
            console.log('Playing sound:', url);
            
            try {
                bellAudio.src = url;
                bellAudio.currentTime = 0;
                bellAudio.play();
            } catch (e) {
                console.error('Error playing bell:', e);
            }
        }
        
        // ===========================================
        // === CLOCK ===
        // ===========================================
        
        function startClock() {
            addClass(audioScreen, 'hidden');
            removeClass(clockScreen, 'hidden');
            
            scheduleNameEl.textContent = scheduleName;
            renderBellList();
            updateClock();
            
            refreshScheduleBtn.textContent = 'üîÑ Refresh';
            refreshScheduleBtn.disabled = false;
            
            updateLastRefreshDisplay();
            
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(updateClock, 1000);
            
            // Try to acquire wake lock
            requestWakeLock();
        }
        
        function updateLastRefreshDisplay() {
            try {
                var savedTimestamp = localStorage.getItem('ellisBellLegacy_timestamp');
                if (savedTimestamp) {
                    var date = new Date(parseInt(savedTimestamp, 10));
                    var timeStr = formatTimeForDisplay(date);
                    lastRefreshEl.textContent = 'Last updated: ' + timeStr + ' (auto-refreshes every 4 hours)';
                } else {
                    lastRefreshEl.textContent = '';
                }
            } catch (e) {
                lastRefreshEl.textContent = '';
            }
        }
        
        function updateClock() {
            var now = getCurrentTimeHHMMSS();
            var nowSeconds = timeToSeconds(now);
            
            currentTimeEl.textContent = formatTime12Hour(now);
            
            var nextBell = null;
            for (var i = 0; i < bells.length; i++) {
                var bellSeconds = timeToSeconds(bells[i].time);
                if (bellSeconds > nowSeconds) {
                    nextBell = bells[i];
                    break;
                }
            }
            
            if (nextBell) {
                var nextBellSeconds = timeToSeconds(nextBell.time);
                var secondsUntil = nextBellSeconds - nowSeconds;
                
                countdownEl.textContent = formatCountdown(secondsUntil);
                nextBellEl.textContent = 'until ' + nextBell.name;
                
                if (secondsUntil <= 0 && secondsUntil > -2 && lastRungBellTime !== nextBell.time) {
                    lastRungBellTime = nextBell.time;
                    playBellSound(nextBell.sound);
                    renderBellList();
                }
            } else {
                countdownEl.textContent = '--:--';
                nextBellEl.textContent = 'No more bells today';
            }
            
            for (var j = 0; j < bells.length; j++) {
                var bell = bells[j];
                var bellTime = bell.time.substring(0, 5);
                var currentTime = now.substring(0, 5);
                
                if (bellTime === currentTime && now.substring(6, 8) === '00' && lastRungBellTime !== bell.time) {
                    lastRungBellTime = bell.time;
                    playBellSound(bell.sound);
                    renderBellList();
                }
            }
        }
        
        function renderBellList() {
            var now = getCurrentTimeHHMMSS();
            var nowSeconds = timeToSeconds(now);
            var html = '';
            var foundNext = false;
            
            for (var i = 0; i < bells.length; i++) {
                var bell = bells[i];
                var bellSeconds = timeToSeconds(bell.time);
                var passed = bellSeconds <= nowSeconds;
                var isNext = !passed && !foundNext;
                
                if (isNext) foundNext = true;
                
                var classes = 'bell-item';
                if (passed) classes += ' bell-passed';
                if (isNext) classes += ' bell-next';
                
                html += '<div class="' + classes + '">';
                html += '<span class="bell-time">' + formatTime12Hour(bell.time) + '</span>';
                html += '<span class="bell-name">' + bell.name + '</span>';
                html += '</div>';
            }
            
            bellListEl.innerHTML = html;
            
            var nextBellItem = bellListEl.querySelector('.bell-next');
            if (nextBellItem) {
                var listTop = bellListEl.scrollTop;
                var listHeight = bellListEl.clientHeight;
                var itemTop = nextBellItem.offsetTop - bellListEl.offsetTop;
                
                if (itemTop < listTop || itemTop > listTop + listHeight * 0.5) {
                    bellListEl.scrollTop = Math.max(0, itemTop - 40);
                }
            }
        }
        
        // ===========================================
        // === DARK MODE ===
        // ===========================================
        
        function toggleDarkMode() {
            toggleClass(document.body, 'dark-mode');
            var isDark = hasClass(document.body, 'dark-mode');
            darkModeBtn.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
            
            try {
                localStorage.setItem('ellisBellLegacy_darkMode', isDark ? '1' : '0');
            } catch (e) {}
        }
        
        function loadDarkModePreference() {
            try {
                var pref = localStorage.getItem('ellisBellLegacy_darkMode');
                if (pref === '1') {
                    addClass(document.body, 'dark-mode');
                    darkModeBtn.textContent = '‚òÄÔ∏è Light';
                }
            } catch (e) {}
        }
        
        // ===========================================
        // === FULLSCREEN ===
        // ===========================================
        
        function toggleFullscreen() {
            var doc = document;
            var docEl = document.documentElement;
            
            var requestFS = docEl.requestFullscreen || docEl.webkitRequestFullscreen || 
                           docEl.mozRequestFullScreen || docEl.msRequestFullscreen;
            var exitFS = doc.exitFullscreen || doc.webkitExitFullscreen || 
                        doc.mozCancelFullScreen || doc.msExitFullscreen;
            var isFS = doc.fullscreenElement || doc.webkitFullscreenElement || 
                      doc.mozFullScreenElement || doc.msFullscreenElement;
            
            try {
                if (!isFS && requestFS) {
                    requestFS.call(docEl);
                } else if (isFS && exitFS) {
                    exitFS.call(doc);
                }
            } catch (e) {
                console.warn('Fullscreen not supported:', e);
            }
        }
        
        function updateFullscreenButton() {
            var doc = document;
            var isFS = doc.fullscreenElement || doc.webkitFullscreenElement || 
                      doc.mozFullScreenElement || doc.msFullscreenElement;
            fullscreenBtn.textContent = isFS ? '‚õ∂ Exit' : '‚õ∂ Full';
        }
        
        // ===========================================
        // === KIOSK MODE ===
        // ===========================================
        
        function enterKioskMode() {
            addClass(document.body, 'kiosk-mode');
            removeClass(kioskExitZone, 'hidden');
            
            // Also try fullscreen
            toggleFullscreen();
            
            try {
                localStorage.setItem('ellisBellLegacy_kioskMode', '1');
            } catch (e) {}
        }
        
        function exitKioskMode() {
            removeClass(document.body, 'kiosk-mode');
            addClass(kioskExitZone, 'hidden');
            
            try {
                localStorage.setItem('ellisBellLegacy_kioskMode', '0');
            } catch (e) {}
        }
        
        function handleKioskExitTap() {
            kioskTapCount++;
            
            if (kioskTapTimer) {
                clearTimeout(kioskTapTimer);
            }
            
            if (kioskTapCount >= 3) {
                kioskTapCount = 0;
                exitKioskMode();
            } else {
                kioskTapTimer = setTimeout(function() {
                    kioskTapCount = 0;
                }, 1000);
            }
        }
        
        function loadKioskModePreference() {
            try {
                var pref = localStorage.getItem('ellisBellLegacy_kioskMode');
                if (pref === '1') {
                    // Delay to let page load first
                    setTimeout(function() {
                        enterKioskMode();
                    }, 500);
                }
            } catch (e) {}
        }
        
        // ===========================================
        // === WAKE LOCK ===
        // ===========================================
        
        function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    navigator.wakeLock.request('screen').then(function(lock) {
                        wakeLock = lock;
                        console.log('Wake lock acquired');
                        
                        wakeLock.addEventListener('release', function() {
                            console.log('Wake lock released');
                        });
                    }).catch(function(e) {
                        console.warn('Wake lock failed:', e);
                    });
                } catch (e) {
                    console.warn('Wake lock not supported:', e);
                }
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock) {
                try {
                    wakeLock.release();
                    wakeLock = null;
                } catch (e) {}
            }
        }
        
        // ===========================================
        // === VISIBILITY API (Battery Saving) ===
        // ===========================================
        
        function handleVisibilityChange() {
            var hidden = document.hidden || document.webkitHidden || document.mozHidden || document.msHidden;
            
            if (hidden) {
                // Page is hidden - pause updates (but keep checking for bells)
                console.log('Page hidden - reducing updates');
            } else {
                // Page is visible again - refresh display
                console.log('Page visible - resuming');
                if (clockInterval) {
                    updateClock();
                    renderBellList();
                }
                // Try to reacquire wake lock
                requestWakeLock();
            }
        }
        
        // ===========================================
        // === HOME SCREEN DETECTION ===
        // ===========================================
        
        function isRunningAsApp() {
            // iOS standalone mode
            if (window.navigator.standalone === true) {
                return true;
            }
            // Android/Chrome standalone mode
            if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
                return true;
            }
            return false;
        }
        
        function showHomescreenHint() {
            if (!isRunningAsApp()) {
                removeClass(homescreenHint, 'hidden');
            }
        }
        
        // ===========================================
        // === EVENT LISTENERS ===
        // ===========================================
        
        loadBtn.onclick = function() {
            loadScheduleFromCode(shareCodeInput.value);
        };
        
        shareCodeInput.onkeypress = function(e) {
            if (e.keyCode === 13 || e.which === 13) {
                loadScheduleFromCode(shareCodeInput.value);
            }
        };
        
        enableAudioBtn.onclick = function() {
            enableAudio();
        };
        
        changeScheduleBtn.onclick = function() {
            if (clockInterval) clearInterval(clockInterval);
            bells = [];
            lastRungBellTime = null;
            addClass(clockScreen, 'hidden');
            removeClass(codeScreen, 'hidden');
            addClass(codeStatus, 'hidden');
            shareCodeInput.value = '';
            shareCodeInput.focus();
            
            releaseWakeLock();
            
            try {
                localStorage.removeItem('ellisBellLegacy_code');
                localStorage.removeItem('ellisBellLegacy_bells');
                localStorage.removeItem('ellisBellLegacy_name');
                localStorage.removeItem('ellisBellLegacy_timestamp');
            } catch (e) {}
        };
        
        refreshScheduleBtn.onclick = function() {
            var savedCode = null;
            try {
                savedCode = localStorage.getItem('ellisBellLegacy_code');
            } catch (e) {}
            
            if (savedCode) {
                refreshScheduleBtn.textContent = '‚è≥ Refreshing...';
                refreshScheduleBtn.disabled = true;
                loadScheduleFromCode(savedCode);
            } else {
                changeScheduleBtn.click();
            }
        };
        
        darkModeBtn.onclick = function() {
            toggleDarkMode();
        };
        
        fullscreenBtn.onclick = function() {
            toggleFullscreen();
        };
        
        kioskBtn.onclick = function() {
            enterKioskMode();
        };
        
        kioskExitZone.onclick = function() {
            handleKioskExitTap();
        };
        
        // Kiosk exit link (visible text in kiosk mode)
        kioskExitLink.onclick = function() {
            handleKioskExitTap();
        };
        
        // Fullscreen change events
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);
        
        // Visibility change events
        var visibilityEvent = 'visibilitychange';
        if (typeof document.webkitHidden !== 'undefined') {
            visibilityEvent = 'webkitvisibilitychange';
        } else if (typeof document.mozHidden !== 'undefined') {
            visibilityEvent = 'mozvisibilitychange';
        } else if (typeof document.msHidden !== 'undefined') {
            visibilityEvent = 'msvisibilitychange';
        }
        document.addEventListener(visibilityEvent, handleVisibilityChange);
        
        // ===========================================
        // === INITIALIZATION ===
        // ===========================================
        
        var REFRESH_INTERVAL_MS = 4 * 60 * 60 * 1000;
        
        function init() {
            // Load preferences
            loadDarkModePreference();
            
            // Show homescreen hint after a delay
            setTimeout(showHomescreenHint, 2000);
            
            try {
                var savedBells = localStorage.getItem('ellisBellLegacy_bells');
                var savedName = localStorage.getItem('ellisBellLegacy_name');
                var savedCode = localStorage.getItem('ellisBellLegacy_code');
                var savedTimestamp = localStorage.getItem('ellisBellLegacy_timestamp');
                
                if (savedBells && savedName) {
                    var isStale = false;
                    if (savedTimestamp) {
                        var age = Date.now() - parseInt(savedTimestamp, 10);
                        isStale = age > REFRESH_INTERVAL_MS;
                        console.log('Cache age: ' + Math.round(age / 60000) + ' minutes, stale: ' + isStale);
                    } else {
                        isStale = true;
                    }
                    
                    if (isStale && savedCode) {
                        console.log('Cache is stale, refreshing schedule...');
                        loadScheduleFromCode(savedCode);
                        return;
                    }
                    
                    bells = JSON.parse(savedBells);
                    scheduleName = savedName;
                    
                    if (bells.length > 0) {
                        addClass(codeScreen, 'hidden');
                        removeClass(audioScreen, 'hidden');
                        
                        // Load kiosk mode preference after showing audio screen
                        loadKioskModePreference();
                        return;
                    }
                }
            } catch (e) {
                console.log('Error loading from cache:', e);
            }
            
            shareCodeInput.focus();
        }
        
        init();
    })();
    </script>
</body>
</html>
